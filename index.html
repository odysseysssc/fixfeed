<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FixYourFeed ‚Äî Take Back Your X Feed</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --cream: #f5f0e6;
      --cream-dark: #e8e2d6;
      --dark: #1a1a1a;
      --gray: #6b6b6b;
      --gray-light: #a3a3a3;
      --green: #2d5a3d;
      --green-light: #4a7c59;
      --green-dim: rgba(45, 90, 61, 0.1);
      --danger: #dc2626;
      --success: #16a34a;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Space Mono', monospace;
      background: var(--cream);
      color: var(--dark);
      min-height: 100vh;
    }

    .container { max-width: 960px; margin: 0 auto; padding: 0 24px; }

    header {
      padding: 24px 0;
      border-bottom: 1px solid var(--cream-dark);
    }

    .logo {
      font-weight: 700; font-size: 16px;
      display: flex; align-items: center; gap: 10px; cursor: pointer;
    }

    .logo-dot {
      width: 12px; height: 12px; background: var(--green); border-radius: 2px;
    }

    .page { display: none; animation: fadeIn 0.4s ease; }
    .page.active { display: block; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Forms & Buttons */
    input[type="text"], input[type="email"] {
      width: 100%; padding: 14px 16px;
      background: var(--cream); border: 2px solid var(--cream-dark); border-radius: 4px;
      color: var(--dark); font-family: 'Space Mono', monospace; font-size: 14px;
      outline: none; transition: border-color 0.2s;
    }
    input:focus { border-color: var(--green); }
    input::placeholder { color: var(--gray-light); }

    .btn {
      padding: 14px 28px; background: var(--green); color: var(--cream);
      font-family: 'Space Mono', monospace; font-size: 14px; font-weight: 700;
      border: none; border-radius: 4px; cursor: pointer;
      transition: background 0.2s;
    }
    .btn:hover { background: var(--dark); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-secondary { background: transparent; color: var(--dark); border: 2px solid var(--cream-dark); }
    .btn-secondary:hover { border-color: var(--dark); background: transparent; }

    /* Page 1: Hero */
    .hero { padding: 80px 0 60px; text-align: center; }
    .hero h1 {
      font-size: clamp(36px, 8vw, 56px); font-weight: 700;
      line-height: 1.1; letter-spacing: -2px; margin-bottom: 20px;
    }
    .hero h1 span { color: var(--green); }
    .hero p { font-size: 16px; color: var(--gray); max-width: 500px; margin: 0 auto 40px; line-height: 1.6; }

    .handle-form { display: flex; gap: 12px; max-width: 400px; margin: 0 auto; }
    .input-wrapper { flex: 1; position: relative; }
    .input-wrapper::before {
      content: '@'; position: absolute; left: 16px; top: 50%; transform: translateY(-50%);
      color: var(--gray); font-family: 'Space Mono', monospace; font-size: 16px;
    }
    .input-wrapper input { padding-left: 40px; }

    /* Loading */
    .loading-page { padding: 120px 0; text-align: center; }
    .spinner {
      width: 48px; height: 48px;
      border: 3px solid var(--cream-dark); border-top-color: var(--green);
      border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 24px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-page p { color: var(--gray); font-family: 'Space Mono', monospace; }

    /* Page 2: Analysis */
    .analysis { padding: 60px 0; }
    .profile-card {
      display: flex; align-items: center; gap: 20px;
      padding: 24px; background: var(--cream-dark); border-radius: 12px; margin-bottom: 32px;
    }
    .profile-avatar {
      width: 64px; height: 64px; border-radius: 50%;
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      overflow: hidden;
      display: flex; align-items: center; justify-content: center;
      font-size: 24px; font-weight: 700; color: var(--cream);
      position: relative;
    }
    .profile-avatar img { 
      width: 100%; height: 100%; object-fit: cover; 
      position: absolute; top: 0; left: 0;
      transition: opacity 0.2s;
    }
    .profile-avatar .initials { 
      font-size: 24px; 
      font-weight: 700;
    }
    .profile-info h3 { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .profile-info span { color: var(--gray); font-family: 'Space Mono', monospace; font-size: 14px; }

    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-bottom: 32px; }
    .stat-card { padding: 24px; background: var(--cream-dark); border-radius: 12px; }
    .stat-number {
      font-size: 36px; font-weight: 800; letter-spacing: -2px;
      margin-bottom: 4px; font-family: 'Space Mono', monospace;
    }
    .stat-label { color: var(--gray); font-size: 14px; }

    .insight {
      padding: 32px;
      background: linear-gradient(135deg, rgba(34, 211, 238, 0.1) 0%, rgba(244, 63, 94, 0.1) 100%);
      border-radius: 12px; border: 1px solid var(--cream-dark);
      margin-bottom: 32px; text-align: center;
    }
    .insight-big { font-size: clamp(32px, 8vw, 48px); font-weight: 800; letter-spacing: -2px; margin-bottom: 8px; }
    .insight-text { color: var(--gray); font-size: 16px; line-height: 1.6; }

    .stat-card.highlight {
      border: 1px solid var(--danger); background: rgba(244, 63, 94, 0.05); text-align: center;
    }
    .stat-card.highlight .stat-number { color: var(--danger); }

    .cta-section {
      text-align: center; padding: 40px; background: var(--cream-dark); border-radius: 12px;
    }
    .cta-section h3 { font-size: 24px; font-weight: 700; margin-bottom: 12px; }
    .cta-section p { color: var(--gray); margin-bottom: 24px; }
    .email-form { display: flex; gap: 12px; max-width: 400px; margin: 0 auto; }
    .email-form input { flex: 1; }

    /* Page 3: Instructions */
    .instructions-page { padding: 80px 0; text-align: center; }
    .success-icon {
      width: 80px; height: 80px; background: var(--success); border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 32px; font-size: 40px;
    }
    .instructions-page h2 { font-size: 32px; margin-bottom: 16px; }
    .instructions-page > .container > p { color: var(--gray); margin-bottom: 40px; }

    .steps-list { text-align: left; max-width: 500px; margin: 0 auto 40px; }
    .step-item {
      display: flex; gap: 16px; margin-bottom: 24px;
      padding: 20px; background: var(--cream-dark); border-radius: 12px;
    }
    .step-number {
      width: 32px; height: 32px; background: var(--green); color: var(--dark);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-weight: 700; flex-shrink: 0;
    }
    .step-content h4 { margin-bottom: 8px; }
    .step-content p { color: var(--gray); font-size: 14px; line-height: 1.6; }
    .step-content a { color: var(--green); }

    /* Page 4: Upload */
    .upload-page { padding: 60px 0; }
    .upload-page h2 { font-size: 32px; margin-bottom: 12px; }
    .upload-page > .container > p { color: var(--gray); margin-bottom: 40px; }

    .demo-notice {
      background: rgba(34, 211, 238, 0.1); border: 1px solid var(--green);
      border-radius: 8px; padding: 12px 16px; margin-bottom: 24px;
      font-size: 13px; display: flex; align-items: center; gap: 10px;
    }

    .upload-zone {
      border: 2px dashed var(--cream-dark); border-radius: 16px;
      padding: 60px; text-align: center; cursor: pointer;
      transition: border-color 0.3s, background 0.3s;
    }
    .upload-zone:hover { border-color: var(--green); background: var(--green-dim); }
    .upload-zone-small { min-height: auto; padding: 20px; }
    .upload-zone-small .upload-icon { display: none; }
    .upload-option-tab.active { background: var(--green) !important; color: var(--cream) !important; }
    .upload-option-tab:hover:not(.active) { border-color: var(--gray); color: var(--dark); }
    .upload-icon {
      width: 64px; height: 64px; background: var(--cream-dark); border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      margin: 0 auto 24px; font-size: 28px;
    }
    .upload-zone h3 { font-size: 20px; margin-bottom: 8px; }
    .upload-zone p { color: var(--gray); font-size: 14px; }

    .processing-info { margin-top: 32px; display: none; }
    .processing-info.active { display: block; }
    .progress-bar {
      height: 4px; background: var(--cream-dark); border-radius: 2px;
      overflow: hidden; margin-bottom: 16px;
    }
    .progress-fill { height: 100%; background: var(--green); width: 0%; transition: width 0.3s; }
    .processing-status { font-family: 'Space Mono', monospace; font-size: 13px; color: var(--gray); }

    /* Page 5: Results */
    .results-page { padding: 60px 0; }
    .results-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 32px; flex-wrap: wrap; gap: 16px;
    }
    .results-header h2 { font-size: 28px; font-weight: 800; }
    .results-summary { display: flex; gap: 24px; font-family: 'Space Mono', monospace; font-size: 14px; }
    .summary-item { display: flex; align-items: center; gap: 8px; }
    .summary-dot { width: 10px; height: 10px; border-radius: 50%; }
    .summary-dot.inactive { background: var(--danger); }
    .summary-dot.active { background: var(--success); }

    .filter-tabs { display: flex; gap: 8px; margin-bottom: 24px; }
    .filter-tab {
      padding: 10px 20px; background: transparent; border: 2px solid var(--cream-dark);
      border-radius: 4px; color: var(--gray); font-family: 'Space Mono', monospace;
      font-size: 13px; cursor: pointer; transition: all 0.2s;
    }
    .filter-tab:hover { border-color: var(--gray); color: var(--dark); }
    .filter-tab.active { background: var(--green); color: var(--cream); border-color: var(--green); }

    .search-input {
      width: 100%; padding: 12px 16px; background: var(--cream);
      border: 2px solid var(--cream-dark); border-radius: 4px; color: var(--dark);
      font-family: 'Space Mono', monospace; font-size: 13px;
      outline: none; margin-bottom: 16px;
    }
    .search-input:focus { border-color: var(--green); }

    .select-bar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 16px; background: var(--cream-dark); border-radius: 8px; margin-bottom: 16px;
    }
    .select-bar label { display: flex; align-items: center; gap: 12px; cursor: pointer; font-size: 14px; }

    .account-list {
      border: 1px solid var(--cream-dark); border-radius: 12px;
      overflow: hidden; max-height: 500px; overflow-y: auto;
    }

    /* Sortable table styles */
    .sortable-table {
      border: 1px solid var(--cream-dark);
      border-radius: 12px;
      overflow: hidden;
    }
    .table-header {
      display: flex;
      padding: 12px 16px;
      background: var(--cream-dark);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--gray);
      gap: 8px;
    }
    .th { display: flex; align-items: center; justify-content: center; }
    .th-check { width: 32px; }
    .th-account { flex: 1; min-width: 180px; justify-content: flex-start; }
    .th-mutual { width: 65px; }
    .th-date { width: 100px; }
    .th-num { width: 55px; }
    .th-action { width: 80px; }
    .th-action-wide { width: 95px; }
    .th.sortable { cursor: pointer; transition: color 0.2s; user-select: none; }
    .th.sortable:hover { color: var(--cream); }
    .th.active-sort { color: var(--green); }
    .table-body { max-height: 400px; overflow-y: auto; }
    .table-row {
      display: flex;
      padding: 12px 16px;
      border-bottom: 1px solid var(--cream-dark);
      align-items: center;
      font-size: 13px;
      gap: 12px;
      transition: background 0.15s;
    }
    .table-row:hover { background: rgba(255,255,255,0.02); }
    .table-row:last-child { border-bottom: none; }
    .table-row.done { opacity: 0.35; }
    .cell { display: flex; align-items: center; justify-content: center; }
    .cell-check { width: 32px; }
    .cell-account { flex: 1; min-width: 180px; flex-direction: row; align-items: center; justify-content: flex-start; gap: 12px; overflow: hidden; }
    .cell-account .avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--cream-dark); flex-shrink: 0; object-fit: cover; }
    .cell-account .account-info { display: flex; flex-direction: column; gap: 2px; overflow: hidden; }
    .cell-account strong { font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .cell-account span { font-size: 11px; color: var(--gray); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .cell-mutual { width: 65px; }
    .cell-date { width: 100px; font-size: 12px; color: var(--gray); }
    .cell-num { width: 55px; font-size: 13px; }
    .cell-action { width: 80px; }
    .cell-action-wide { width: 95px; }
    
    .done-checkbox { width: 16px; height: 16px; accent-color: var(--success); cursor: pointer; }
    .select-all-checkbox { width: 16px; height: 16px; accent-color: var(--green); cursor: pointer; }
    
    .action-link {
      font-size: 11px; font-weight: 600; text-decoration: none;
      padding: 5px 10px; border-radius: 4px; transition: all 0.15s;
    }
    .action-link-danger { color: var(--danger); border: 1px solid var(--danger); }
    .action-link-danger:hover { background: var(--danger); color: var(--dark); }
    .action-link-success { color: var(--success); border: 1px solid var(--success); }
    .action-link-success:hover { background: var(--success); color: var(--dark); }

    /* Main tabs */
    .main-tabs {
      display: flex;
      border-bottom: 2px solid var(--cream-dark);
      margin-bottom: 20px;
    }
    .main-tab {
      flex: 1;
      padding: 14px 16px;
      background: none;
      border: none;
      color: var(--gray);
      font-family: 'Space Mono', monospace;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }
    .main-tab:hover { color: var(--dark); }
    .main-tab.active { color: var(--dark) !important; }
    .main-tab.active[data-tab="dead"] { border-bottom-color: var(--danger); color: var(--dark) !important; }
    .main-tab.active[data-tab="people"] { border-bottom-color: var(--green); color: var(--dark) !important; }
    .tab-count { margin-left: 6px; font-family: 'Space Mono', monospace; font-size: 13px; }
    .main-tab[data-tab="dead"] .tab-count { color: var(--danger); }
    .main-tab[data-tab="people"] .tab-count { color: var(--green); }
    
    .tab-content { }
    .tab-desc { color: var(--dark); font-size: 14px; margin-bottom: 16px; }
    
    .table-controls {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
      align-items: center;
    }
    .table-controls .search-input { flex: 1; min-width: 180px; margin: 0; }
    .table-controls .filter-tabs { margin: 0; }
    
    .table-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 12px;
      padding-top: 12px;
    }
    .progress-text { color: var(--gray); font-size: 13px; }
    .btn-sm { padding: 8px 14px; font-size: 12px; }
    
    .extension-cta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      background: linear-gradient(135deg, rgba(34, 211, 238, 0.08) 0%, transparent 100%);
      border: 1px solid var(--cream-dark);
      border-radius: 12px;
      padding: 20px 24px;
      margin-top: 32px;
    }
    .extension-cta h3 { font-size: 16px; margin-bottom: 4px; }
    .extension-cta p { color: var(--gray); font-size: 13px; }
    .account-item {
      display: flex; align-items: center; gap: 16px;
      padding: 16px; border-bottom: 1px solid var(--cream-dark);
    }
    .account-item:last-child { border-bottom: none; }
    .account-checkbox { width: 20px; height: 20px; accent-color: var(--danger); }
    .account-info { flex: 1; }
    .account-name { font-weight: 600; margin-bottom: 2px; }
    .account-handle { color: var(--gray); font-family: 'Space Mono', monospace; font-size: 13px; }
    .account-badge { padding: 4px 10px; border-radius: 100px; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .badge-inactive { background: rgba(244, 63, 94, 0.15); color: var(--danger); }
    .badge-active { background: rgba(34, 197, 94, 0.15); color: var(--success); }

    .cta-bar {
      position: sticky; bottom: 0; background: var(--dark);
      border-top: 1px solid var(--cream-dark); padding: 24px 0; margin-top: 32px;
    }
    .cta-content { display: flex; justify-content: space-between; align-items: center; gap: 24px; }
    .cta-info h3 { font-size: 20px; margin-bottom: 4px; }
    .cta-info p { color: var(--gray); font-size: 14px; }
    .price {
      font-family: 'Space Mono', monospace;
      background: rgba(255, 255, 255, 0.15); padding: 4px 10px; border-radius: 4px; font-size: 14px;
    }

    /* Page 6: Final */
    .final-page { padding: 80px 0; text-align: center; }
    .highlight-box {
      background: var(--cream-dark); border-radius: 12px;
      padding: 24px; margin: 32px auto; max-width: 300px;
    }
    .highlight-box h4 { font-size: 12px; text-transform: uppercase; letter-spacing: 1px; color: var(--gray); margin-bottom: 8px; }
    .highlight-number { font-size: 48px; font-weight: 800; font-family: 'Space Mono', monospace; color: var(--danger); }

    /* Tweet cards */
    .tweets-list { display: flex; flex-direction: column; gap: 12px; }
    .tweet-card {
      background: var(--cream-dark); border-radius: 10px; padding: 16px;
      border: 1px solid transparent; transition: border-color 0.2s;
    }
    .tweet-card:hover { border-color: var(--gray); }
    .tweet-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .tweet-date { color: var(--gray); font-size: 12px; margin-left: auto; }
    .tweet-text { font-size: 14px; line-height: 1.5; margin-bottom: 12px; word-break: break-word; }
    .tweet-text a { color: var(--green); text-decoration: none; }
    .tweet-stats { display: flex; gap: 20px; }
    .tweet-stat { display: flex; align-items: center; gap: 6px; font-size: 13px; color: var(--gray); }
    .tweet-stat span { font-family: 'Space Mono', monospace; color: var(--cream); }
    .tweet-link { margin-left: auto; }
    .tweet-link a { color: var(--green); font-size: 12px; text-decoration: none; }
    .tweet-link a:hover { text-decoration: underline; }

    /* Insight cards */
    .insight-card {
      background: var(--cream-dark); border-radius: 12px; padding: 20px;
    }
    .filter-tabs-sm { gap: 4px; }
    .filter-tabs-sm .filter-tab { padding: 4px 10px; font-size: 11px; }
    
    /* Modal */
    .modal { display: flex; }
    .modal-content { animation: modalIn 0.2s ease-out; }
    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    
    @media (max-width: 900px) {
      .insights-grid { grid-template-columns: 1fr !important; }
    }

    .explanation {
      background: linear-gradient(135deg, rgba(34, 211, 238, 0.1) 0%, transparent 100%);
      border: 1px solid var(--cream-dark); border-radius: 12px; padding: 24px;
      margin-top: 40px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto;
    }
    .explanation h4 { margin-bottom: 12px; }
    .explanation p { color: var(--gray); font-size: 14px; line-height: 1.7; }

    footer { padding: 40px 0; border-top: 1px solid var(--cream-dark); margin-top: 60px; }
    footer p { color: var(--gray); font-size: 14px; text-align: center; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="logo" id="logoBtn">
        <div class="logo-dot"></div>
        fixyourfeed
      </div>
    </div>
  </header>

  <main>
    <!-- Page 1: Hero + Archive Request Combined -->
    <div class="page hero active" id="page1">
      <div class="container">
        <h1>fix your <span>X feed</span></h1>
        <p>Cut through the noise. Your archive reveals who you actually engage with ‚Äî curate them into a list, unfollow the rest. Better signal, better ratio, better reach.</p>
        
        <div class="value-props" style="display: flex; gap: 32px; justify-content: center; margin: 40px 0; flex-wrap: wrap;">
          <div style="background: var(--cream-dark); border-radius: 8px; padding: 24px; text-align: left; max-width: 280px; position: relative;">
            <div style="position: absolute; top: -12px; left: 20px; background: var(--green); color: var(--cream); font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 4px;">STEP 1</div>
            <div style="font-size: 24px; margin-bottom: 12px;">‚≠ê</div>
            <div style="font-size: 15px; color: var(--dark); font-weight: 700; margin-bottom: 8px;">Curate your people</div>
            <div style="font-size: 13px; color: var(--gray); line-height: 1.5;">We analyze your archive to find accounts you actually engage with. Filter by engagement count, add them to an X list, pin it to your feed ‚Äî pure signal, no algo.</div>
          </div>
          <div style="background: var(--cream-dark); border-radius: 8px; padding: 24px; text-align: left; max-width: 280px; position: relative;">
            <div style="position: absolute; top: -12px; left: 20px; background: var(--danger); color: white; font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 4px;">STEP 2</div>
            <div style="font-size: 24px; margin-bottom: 12px;">üßπ</div>
            <div style="font-size: 15px; color: var(--dark); font-weight: 700; margin-bottom: 8px;">Clean up the rest</div>
            <div style="font-size: 13px; color: var(--gray); line-height: 1.5;">Unfollow everyone NOT on your curated list. Better follower:following ratio = algo rewards you more. Less noise = better main feed when you want it.</div>
          </div>
        </div>

        <!-- Archive section -->
        <div style="max-width: 500px; margin: 0 auto;">
          <h2 style="font-size: 20px; text-align: center; margin-bottom: 8px;">get started</h2>
          <p style="text-align: center; color: var(--gray); font-size: 14px; margin-bottom: 24px;">Upload your X archive ‚Äî we'll crunch the numbers and show you who matters</p>
          
          <!-- Upload zone -->
          <div class="upload-zone" id="uploadZone" style="margin-bottom: 16px;">
            <div class="upload-icon">üìÅ</div>
            <h3>Drop your X archive here</h3>
            <p>.zip or .json</p>
          </div>

          <div class="processing-info" id="processingInfo">
            <div class="progress-bar">
              <div class="progress-fill" id="uploadProgress"></div>
            </div>
            <div class="processing-status" id="uploadStatus">Processing...</div>
          </div>

          <!-- How to request archive -->
          <details style="margin-bottom: 16px;">
            <summary style="cursor: pointer; color: var(--gray); font-size: 15px; text-align: center; list-style: none; display: flex; align-items: center; justify-content: center; gap: 8px;">
              <span>How do I request my X archive?</span>
              <span style="font-size: 10px; transition: transform 0.2s;">‚ñº</span>
            </summary>
            <div style="background: var(--cream-dark); border-radius: 12px; padding: 24px; margin-top: 16px; text-align: left;">
              <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 16px;">
                <div style="background: var(--green); color: var(--dark); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; flex-shrink: 0;">1</div>
                <div style="flex: 1;">
                  <strong style="font-size: 14px;">Request your archive from X</strong>
                  <p style="color: var(--gray); font-size: 13px; margin-top: 4px; margin-bottom: 12px;">X takes 24-48 hours to prepare it. They'll email you when it's ready.</p>
                  <a href="https://x.com/settings/download_your_data" target="_blank" class="btn btn-sm" style="display: inline-flex; align-items: center; gap: 6px;">Request archive ‚Üó</a>
                </div>
              </div>
              <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 20px;">
                <div style="background: var(--gray); color: var(--dark); width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 12px; flex-shrink: 0;">2</div>
                <div>
                  <strong style="font-size: 14px;">Come back and upload</strong>
                  <p style="color: var(--gray); font-size: 13px; margin-top: 4px;">Once it's ready, upload the zip file here. We'll analyze it in 30 seconds.</p>
                </div>
              </div>
            </div>
          </details>

          <!-- Privacy-first option -->
          <details style="margin-bottom: 24px;">
            <summary style="cursor: pointer; color: var(--dark); font-size: 14px; text-align: center; list-style: none; display: flex; align-items: center; justify-content: center; gap: 8px;">
              <span>Big file? Upload just 4 files instead</span>
              <span style="font-size: 10px; transition: transform 0.2s;">‚ñº</span>
            </summary>
            <div style="background: var(--cream-dark); border-radius: 4px; padding: 20px; margin-top: 16px;">
              <p style="color: var(--dark); font-size: 13px; margin-bottom: 16px; text-align: center;">
                Upload only these 4 files from your archive's <code style="background: var(--dark); color: var(--cream); padding: 2px 6px; border-radius: 2px;">data/</code> folder:
              </p>
              
              <div style="display: grid; gap: 8px; margin-bottom: 16px;">
                <div style="display: flex; align-items: center; gap: 10px; font-size: 13px;">
                  <span class="file-status" id="statusFollowing" style="width: 20px; height: 20px; border-radius: 50%; background: var(--cream); border: 2px solid var(--gray); display: flex; align-items: center; justify-content: center; font-size: 10px;">‚àí</span>
                  <span style="color: var(--dark);">following.js</span>
                  <span style="color: var(--gray); font-size: 11px; margin-left: auto;">who you follow</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; font-size: 13px;">
                  <span class="file-status" id="statusFollower" style="width: 20px; height: 20px; border-radius: 50%; background: var(--cream); border: 2px solid var(--gray); display: flex; align-items: center; justify-content: center; font-size: 10px;">‚àí</span>
                  <span style="color: var(--dark);">follower.js</span>
                  <span style="color: var(--gray); font-size: 11px; margin-left: auto;">who follows you</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; font-size: 13px;">
                  <span class="file-status" id="statusLike" style="width: 20px; height: 20px; border-radius: 50%; background: var(--cream); border: 2px solid var(--gray); display: flex; align-items: center; justify-content: center; font-size: 10px;">‚àí</span>
                  <span style="color: var(--dark);">like.js</span>
                  <span style="color: var(--gray); font-size: 11px; margin-left: auto;">tweets you liked</span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px; font-size: 13px;">
                  <span class="file-status" id="statusTweets" style="width: 20px; height: 20px; border-radius: 50%; background: var(--cream); border: 2px solid var(--gray); display: flex; align-items: center; justify-content: center; font-size: 10px;">‚àí</span>
                  <span style="color: var(--dark);">tweets.js</span>
                  <span style="color: var(--gray); font-size: 11px; margin-left: auto;">your tweets/replies</span>
                </div>
              </div>

              <div class="upload-zone upload-zone-small" id="uploadZoneFiles" style="padding: 16px;">
                <p style="margin: 0; font-size: 13px;">Drop files here or click to browse</p>
              </div>

              <button class="btn" id="processFilesBtn" style="width: 100%; margin-top: 12px;" disabled>
                Process files <span id="filesReadyCount">(0/4 ready)</span>
              </button>
              
              <p style="text-align: center; color: var(--success); font-size: 11px; margin-top: 12px; margin-bottom: 0;">
                ‚úì These files contain no DMs, emails, or personal data
              </p>
            </div>
          </details>

          <div style="text-align: center; margin-top: 24px; padding: 16px; background: var(--cream-dark); border-radius: 4px;">
            <p style="color: var(--gray); font-size: 12px; line-height: 1.5; margin: 0;">
              üîí <strong>100% private</strong> ‚Äî processed entirely in your browser. We never see, store, or access your data.
            </p>
          </div>
        </div>

        <!-- How it works section -->
        <div style="max-width: 600px; margin: 60px auto 0; padding: 0 24px;">
          <h3 style="font-size: 18px; text-align: center; margin-bottom: 24px;">how it works</h3>
          
          <div style="display: grid; gap: 20px;">
            <div style="display: flex; gap: 16px; align-items: flex-start;">
              <div style="background: var(--green); color: var(--cream); min-width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700;">1</div>
              <div>
                <strong style="font-size: 14px;">Upload your archive</strong>
                <p style="color: var(--gray); font-size: 13px; margin-top: 4px;">Your archive contains every like, reply, and retweet. We analyze it locally in your browser ‚Äî nothing leaves your device.</p>
              </div>
            </div>
            
            <div style="display: flex; gap: 16px; align-items: flex-start;">
              <div style="background: var(--green); color: var(--cream); min-width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700;">2</div>
              <div>
                <strong style="font-size: 14px;">See who you actually engage with</strong>
                <p style="color: var(--gray); font-size: 13px; margin-top: 4px;">Filter by engagement count (5+, 10+, 20+) to find your real community. These are the accounts worth keeping.</p>
              </div>
            </div>
            
            <div style="display: flex; gap: 16px; align-items: flex-start;">
              <div style="background: var(--green); color: var(--cream); min-width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700;">3</div>
              <div>
                <strong style="font-size: 14px;">Curate them into a list</strong>
                <p style="color: var(--gray); font-size: 13px; margin-top: 4px;">Use our free extension to bulk add your engaged accounts to an X list. Pin that list to your feed tabs for a clean, algo-free timeline.</p>
              </div>
            </div>
            
            <div style="display: flex; gap: 16px; align-items: flex-start;">
              <div style="background: var(--danger); color: white; min-width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: 700;">4</div>
              <div>
                <strong style="font-size: 14px;">Clean up the rest</strong>
                <p style="color: var(--gray); font-size: 13px; margin-top: 4px;">The extension's "clean up" mode unfollows everyone NOT on your curated list. Better ratio = algo favors you. Less noise = better feed.</p>
              </div>
            </div>
          </div>
          
          <div style="background: var(--green-dim); border-radius: 8px; padding: 16px; margin-top: 24px; text-align: center;">
            <p style="color: var(--dark); font-size: 13px; margin: 0;">
              <strong>100% free.</strong> No account needed. No catch. Your data never leaves your browser.
            </p>
          </div>
          
          <p style="text-align: center; margin-top: 24px;">
            <a href="https://x.com/OdysseySSSC" target="_blank" style="color: var(--dark); text-decoration: none; font-size: 13px;">built by <code style="background: var(--dark); color: var(--cream); padding: 4px 8px; border-radius: 2px; font-size: 12px;">@OdysseySSSC</code></a>
          </p>
        </div>
      </div>
    </div>

    <!-- Results Page -->
    <div class="page analysis" id="page2">
      <div class="container">
          
          <!-- Header with change option -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div></div>
            <button id="changeArchiveBtn" style="background: none; border: none; color: var(--gray); font-size: 13px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
              ‚Üª Upload different archive
            </button>
          </div>
          
          <!-- Global resolve prompt - shows first time before data is usable -->
          <div id="resolvePrompt" style="background: var(--cream-dark); border-radius: 4px; padding: 24px; margin-bottom: 24px; display: none;">
            <div style="text-align: center; max-width: 500px; margin: 0 auto;">
              <span style="font-size: 32px; display: block; margin-bottom: 12px;">üîó</span>
              <h3 style="font-size: 18px; margin-bottom: 8px;">one more step</h3>
              <p style="color: var(--gray); font-size: 14px; margin-bottom: 16px;">X archives no longer include usernames ‚Äî just user IDs. We need to resolve these to actual @handles before we can show you useful data.</p>
              <p style="color: var(--gray); font-size: 13px; margin-bottom: 20px;">This requires the extension and takes ~2 seconds per account. For <strong id="unresolvedCountPrompt">0</strong> accounts, that's about <strong id="estimatedTimePrompt">0 mins</strong>. Only needs to run once ‚Äî we'll cache the results.</p>
              
              <div style="display: flex; flex-direction: column; gap: 12px; align-items: center;">
                <a href="extension.html" target="_blank" class="btn" style="display: inline-block; text-decoration: none; padding: 12px 24px;">1. Get the Extension</a>
                <p style="font-size: 12px; color: var(--gray);">Make sure you have <a href="https://x.com" target="_blank" style="color: var(--green);">x.com</a> open and are logged in</p>
                <button id="startResolveBtn" class="btn" style="padding: 12px 24px;">2. Start Resolving</button>
              </div>
              
              <p style="font-size: 12px; color: var(--gray); margin-top: 16px;">Or <a href="#" id="skipResolveBtn" style="color: var(--dark);">skip and view raw data ‚Üí</a></p>
            </div>
          </div>
          
          <!-- Resolving in progress banner (global) -->
          <div id="resolvingBannerGlobal" style="background: var(--green); color: var(--cream); border-radius: 4px; padding: 16px 20px; margin-bottom: 24px; display: none;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <div style="display: flex; align-items: center; gap: 10px;">
                <span class="spinner-small" style="width: 16px; height: 16px; border: 2px solid var(--cream); border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></span>
                <span style="font-size: 14px;"><strong id="resolvingCountGlobal">0</strong> / <strong id="resolvingTotalGlobal">0</strong> handles resolved</span>
              </div>
              <button id="pauseResolveBtnGlobal" class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px; background: transparent; border-color: var(--cream); color: var(--cream);">Pause</button>
            </div>
            <div style="background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px;">
              <div id="resolveProgressBarGlobal" style="background: var(--cream); height: 100%; border-radius: 3px; width: 0%; transition: width 0.3s;"></div>
            </div>
            <p style="font-size: 12px; opacity: 0.8; margin-top: 8px;">Tables will update as handles are resolved. You can keep browsing.</p>
          </div>
          
          <!-- Main tabs - hidden, just Your People now -->
          <div id="mainTabsSection" class="main-tabs" style="display: none;">
            <button class="main-tab active" data-tab="people">
              ‚≠ê Your people <span class="tab-count" id="peopleCount">0</span>
            </button>
            <button class="main-tab" data-tab="dead">
              üíÄ Dead weight <span class="tab-count" id="deadCount">0</span>
            </button>
          </div>

          <!-- Dead weight section - hidden -->
          <div id="deadSection" class="tab-content" style="display: none;">
            <p class="tab-desc">Accounts you follow but don't engage with. Don't unfollow these directly ‚Äî use the "clean up" feature after curating your list to safely remove everyone not on it.</p>
            
            <div class="table-controls">
              <input type="text" class="search-input" id="searchInputDead" placeholder="Search...">
              <div class="filter-tabs" id="filterTabsDead">
                <button class="filter-tab active" data-filter="zero">No engagement</button>
                <button class="filter-tab" data-filter="noFollowBack">Doesn't follow back</button>
                <button class="filter-tab" data-filter="all">All accounts</button>
              </div>
            </div>

            <div class="sortable-table">
              <div class="table-header" id="deadTableHeader">
                <div class="th th-check"><input type="checkbox" id="selectAllDead" class="select-all-checkbox" title="Select all"></div>
                <div class="th th-account sortable" data-sort="name">Account</div>
                <div class="th th-date sortable active-sort desc" data-sort="lastEngaged">Last engaged ‚Üì</div>
                <div class="th th-num sortable" data-sort="engagements">Engagements</div>
                <div class="th th-action"></div>
              </div>
              <div class="table-body" id="deadList"></div>
            </div>

            <div class="table-footer">
              <span class="progress-text"><span id="totalDeadCount">0</span> accounts</span>
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 12px; color: var(--gray);">Use with our free extension to mass unfollow ‚Üí</span>
                <button class="btn btn-secondary btn-sm" id="copyDeadBtn">Copy handles</button>
              </div>
            </div>
          </div>

          <!-- Two-step process header -->
          <div style="margin-bottom: 32px;">
            <h2 style="font-size: 24px; text-align: center; margin-bottom: 24px;">üéØ Fix your feed in 2 steps</h2>
            
            <!-- Extension download box -->
            <div style="background: var(--green); color: var(--cream); border-radius: 8px; padding: 20px; margin-bottom: 24px; text-align: center;">
              <p style="font-size: 14px; margin-bottom: 12px;"><strong>‚ö° You'll need the free browser extension</strong></p>
              <a href="extension.html" target="_blank" class="btn" style="background: var(--cream); color: var(--dark); text-decoration: none; display: inline-block; padding: 12px 24px;">Download Extension</a>
              <p style="font-size: 12px; margin-top: 12px; opacity: 0.9;">Chrome/Brave/Edge ‚Ä¢ Unzip ‚Üí chrome://extensions ‚Üí Load unpacked</p>
            </div>
            
            <div style="display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; margin-bottom: 24px;">
              <!-- Step 1 -->
              <div style="flex: 1; min-width: 280px; max-width: 400px; background: var(--cream-dark); border-radius: 8px; padding: 20px; position: relative;">
                <div style="position: absolute; top: -10px; left: 16px; background: var(--green); color: var(--cream); font-size: 11px; font-weight: 700; padding: 4px 12px; border-radius: 4px;">STEP 1: CURATE</div>
                <div style="margin-top: 8px;">
                  <p style="font-size: 13px; color: var(--dark); line-height: 1.6; margin-bottom: 0;">
                    <strong>1.</strong> Choose min engagements below (5+ recommended)<br>
                    <strong>2.</strong> Click "Select all" then "Copy handles"<br>
                    <strong>3.</strong> <a href="https://x.com/i/lists/create" target="_blank" style="color: var(--green);">Create a new X list</a> and copy its URL<br>
                    <strong>4.</strong> Open extension ‚Üí "Curate list" tab<br>
                    <strong>5.</strong> Paste handles + list URL ‚Üí Start
                  </p>
                </div>
              </div>
              
              <!-- Step 2 -->
              <div style="flex: 1; min-width: 280px; max-width: 400px; background: var(--cream-dark); border-radius: 8px; padding: 20px; position: relative; opacity: 0.7;">
                <div style="position: absolute; top: -10px; left: 16px; background: var(--danger); color: white; font-size: 11px; font-weight: 700; padding: 4px 12px; border-radius: 4px;">STEP 2: CLEAN UP</div>
                <div style="margin-top: 8px;">
                  <p style="font-size: 13px; color: var(--dark); line-height: 1.6; margin-bottom: 12px;">
                    <strong>After Step 1 completes:</strong><br>
                    <strong>1.</strong> Open extension ‚Üí "Clean up" tab<br>
                    <strong>2.</strong> Paste the same list URL<br>
                    <strong>3.</strong> Click Start ‚Äî unfollows everyone NOT on your curated list
                  </p>
                  <p style="font-size: 11px; color: var(--gray); margin: 0;">‚ö†Ô∏è Only do this after your curated list is complete</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Your people section -->
          <div id="peopleSection" class="tab-content" style="display: block;">
            <h3 style="font-size: 16px; margin-bottom: 16px;">‚≠ê Your People <span style="color: var(--gray); font-weight: 400;">‚Äî accounts you actually engage with</span></h3>
            
            <div class="table-controls" style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
              <input type="text" class="search-input" id="searchInputPeople" placeholder="Search..." style="flex: 1; min-width: 150px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-size: 12px; color: var(--gray); white-space: nowrap;">Lookback:</label>
                <select id="lookbackFilter" style="padding: 8px 12px; border: 2px solid var(--cream-dark); border-radius: 4px; background: var(--cream); font-family: 'Space Mono', monospace; font-size: 12px;">
                  <option value="all" selected>All time</option>
                  <option value="5">5 years</option>
                  <option value="4">4 years</option>
                  <option value="3">3 years</option>
                  <option value="2">2 years</option>
                  <option value="1">1 year</option>
                </select>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-size: 12px; color: var(--gray); white-space: nowrap;">Min engagements:</label>
                <select id="minEngagementFilter" style="padding: 8px 12px; border: 2px solid var(--cream-dark); border-radius: 4px; background: var(--cream); font-family: 'Space Mono', monospace; font-size: 12px;">
                  <option value="1">1+</option>
                  <option value="2">2+</option>
                  <option value="3">3+</option>
                  <option value="5" selected>5+</option>
                  <option value="10">10+</option>
                  <option value="20">20+</option>
                </select>
              </div>
            </div>

            <div class="sortable-table">
              <div class="table-header" id="peopleTableHeader">
                <div class="th th-check"><input type="checkbox" id="selectAllPeople" class="select-all-checkbox" title="Select all"></div>
                <div class="th th-account sortable" data-sort="name">Account</div>
                <div class="th th-date sortable" data-sort="lastEngaged">Last engaged</div>
                <div class="th th-num sortable active-sort desc" data-sort="engagements">Engagements ‚Üì</div>
                <div class="th th-action"></div>
              </div>
              <div class="table-body" id="peopleList"></div>
            </div>

            <div class="table-footer">
              <span class="progress-text"><span id="totalPeopleCount">0</span> accounts (of <span id="totalPeopleUnfiltered">0</span> total)</span>
              <div style="display: flex; align-items: center; gap: 12px;">
                <button class="btn btn-sm" id="selectAllPeopleBtn" style="padding: 8px 16px;">Select all</button>
                <button class="btn btn-secondary btn-sm" id="copyPeopleBtn">Copy handles</button>
              </div>
            </div>
          </div>

          <!-- Tip jar -->
          <div style="text-align: center; margin-top: 24px; padding: 20px; background: var(--cream-dark); border-radius: 4px;">
            <p style="color: var(--gray); font-size: 14px; margin-bottom: 12px;">Found this useful? Leave a tip ü§ô</p>
            <div style="display: flex; align-items: center; justify-content: center; gap: 8px;">
              <code id="tipAddress" style="background: var(--dark); padding: 10px 14px; border-radius: 4px; font-size: 12px; color: var(--cream);">0x9FD6F93Cb85dadF4437B83f0281B50024fE5f8b0</code>
              <button id="copyTipBtn" class="btn btn-sm btn-secondary" style="padding: 10px 14px;">Copy</button>
            </div>
            <p style="color: var(--gray); font-size: 11px; margin-top: 8px;">Any EVM chain (ETH, Base, etc.)</p>
            <p style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--cream);">
              <a href="https://x.com/OdysseySSSC" target="_blank" style="color: var(--dark); text-decoration: none; font-size: 13px;">follow me on X <code style="background: var(--dark); color: var(--cream); padding: 4px 8px; border-radius: 2px; font-size: 12px;">@OdysseySSSC</code></a>
            </p>
          </div>

          <!-- Insights Section -->
          <div class="insights-section" style="margin-top: 48px; padding-top: 48px; border-top: 1px solid var(--cream-dark);">
            <h2 style="font-size: 20px; margin-bottom: 32px; color: var(--dark);">üìä Insights</h2>
            
            <div class="insights-grid" style="display: grid; grid-template-columns: 1fr; gap: 32px;">
              
              <!-- Top Tweets -->
              <div class="insight-card">
                <div class="insight-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                  <h3 style="font-size: 16px; display: flex; align-items: center; gap: 8px; color: var(--dark);">üî• Top Tweets <span style="color: var(--gray); font-weight: 400; font-size: 14px;" id="topTweetsCount2"></span></h3>
                  <div class="filter-tabs filter-tabs-sm" id="filterTabsTweets">
                    <button class="filter-tab active" data-filter="all">All accounts</button>
                    <button class="filter-tab" data-filter="original">Original</button>
                    <button class="filter-tab" data-filter="replies">Replies</button>
                  </div>
                </div>
                <input type="text" class="search-input" id="searchInputTweets" placeholder="Search tweets..." style="margin-bottom: 12px;">
                <div class="tweets-list" id="topTweetsList" style="max-height: 400px; overflow-y: auto;"></div>
              </div>

              <!-- Most Mentioned -->
              <div class="insight-card">
                <div class="insight-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                  <h3 style="font-size: 16px; display: flex; align-items: center; gap: 8px; color: var(--dark);">üì£ Most Mentioned <span style="color: var(--gray); font-weight: 400; font-size: 14px;" id="mentionsCount2"></span></h3>
                </div>
                <input type="text" class="search-input" id="searchInputMentions" placeholder="Search..." style="margin-bottom: 12px;">
                <div class="sortable-table" style="max-height: 400px; overflow-y: auto;">
                  <div class="table-header" id="mentionsTableHeader">
                    <div class="th th-account">Account</div>
                    <div class="th th-num sortable active-sort desc" data-sort="mentions">Mentions ‚Üì</div>
                    <div class="th th-num sortable" data-sort="replies">Replies</div>
                    <div class="th th-date sortable" data-sort="lastMentioned">Last</div>
                  </div>
                  <div class="table-body" id="mentionsList"></div>
                </div>
              </div>

            </div>
          </div>

        </div>

      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>FixYourFeed ‚Äî Take back your timeline.</p>
    </div>
  </footer>

  <script>
    // State
    let currentPage = 1;
    let allAccounts = [];
    let allTweets = [];
    let allMentions = [];

    // Real profile data
    const knownProfiles = {
      'odysseysssc': {
        name: 'Odyssey ü§ô',
        handle: 'odysseysssc',
        following: 3426,
        followers: 5143,
        joinedYear: 2012
      }
    };

    // Sample data with engagement metrics from archive
    const sampleAccounts = [
      { handle: 'naval', name: 'Naval', followsBack: true, followedSince: '2018-03', engagements: 47, likes: 32, replies: 12, rts: 3, lastInteraction: '2025-12' },
      { handle: 'pmarca', name: 'Marc Andreessen', followsBack: false, followedSince: '2019-06', engagements: 23, likes: 18, replies: 4, rts: 1, lastInteraction: '2025-11' },
      { handle: 'elonmusk', name: 'Elon Musk', followsBack: false, followedSince: '2017-01', engagements: 15, likes: 12, replies: 2, rts: 1, lastInteraction: '2026-01' },
      { handle: 'vitalikbuterin', name: 'Vitalik Buterin', followsBack: false, followedSince: '2020-08', engagements: 31, likes: 22, replies: 6, rts: 3, lastInteraction: '2025-10' },
      { handle: 'balajis', name: 'Balaji', followsBack: false, followedSince: '2021-02', engagements: 19, likes: 14, replies: 3, rts: 2, lastInteraction: '2025-09' },
      { handle: 'jessepollak', name: 'Jesse Pollak', followsBack: true, followedSince: '2023-05', engagements: 52, likes: 35, replies: 12, rts: 5, lastInteraction: '2026-01' },
      { handle: 'techcrunch', name: 'TechCrunch', followsBack: false, followedSince: '2015-09', engagements: 2, likes: 2, replies: 0, rts: 0, lastInteraction: '2024-03' },
      { handle: 'randomstartup', name: 'Random Startup', followsBack: false, followedSince: '2022-11', engagements: 0, likes: 0, replies: 0, rts: 0, lastInteraction: null },
      { handle: 'oldcontact', name: 'Old Contact', followsBack: true, followedSince: '2014-06', engagements: 1, likes: 1, replies: 0, rts: 0, lastInteraction: '2023-08' },
      { handle: 'newsbot', name: 'News Bot', followsBack: false, followedSince: '2021-03', engagements: 0, likes: 0, replies: 0, rts: 0, lastInteraction: null },
      { handle: 'deadaccount2019', name: 'Inactive Since 2019', followsBack: false, followedSince: '2018-02', engagements: 0, likes: 0, replies: 0, rts: 0, lastInteraction: null },
      { handle: 'brandaccount', name: 'Some Brand', followsBack: false, followedSince: '2020-07', engagements: 0, likes: 0, replies: 0, rts: 0, lastInteraction: null },
      { handle: 'spammy_promo', name: 'Spammy Promo', followsBack: false, followedSince: '2023-01', engagements: 0, likes: 0, replies: 0, rts: 0, lastInteraction: null },
      { handle: 'forgottenfollow', name: 'Who Is This', followsBack: false, followedSince: '2019-04', engagements: 0, likes: 0, replies: 0, rts: 0, lastInteraction: null },
      { handle: 'coingecko', name: 'CoinGecko', followsBack: false, followedSince: '2021-08', engagements: 3, likes: 2, replies: 1, rts: 0, lastInteraction: '2024-06' },
      { handle: 'oldpodcast', name: 'Podcast I Never Listen To', followsBack: false, followedSince: '2017-11', engagements: 0, likes: 0, replies: 0, rts: 0, lastInteraction: null },
      { handle: 'randominfluencer', name: 'Random Influencer', followsBack: false, followedSince: '2022-05', engagements: 0, likes: 0, replies: 0, rts: 0, lastInteraction: null },
      { handle: 'deadproject', name: 'Dead Project', followsBack: false, followedSince: '2021-06', engagements: 0, likes: 0, replies: 0, rts: 0, lastInteraction: null },
      { handle: 'nft_thing', name: 'NFT Project', followsBack: false, followedSince: '2022-01', engagements: 1, likes: 1, replies: 0, rts: 0, lastInteraction: '2023-05' },
      { handle: 'cryptonews', name: 'Crypto News', followsBack: false, followedSince: '2020-12', engagements: 0, likes: 0, replies: 0, rts: 0, lastInteraction: null },
      { handle: 'ghostaccount', name: 'Ghost', followsBack: false, followedSince: '2016-08', engagements: 0, likes: 0, replies: 0, rts: 0, lastInteraction: null },
      { handle: 'nobodyknows', name: 'Anonymous User', followsBack: false, followedSince: '2023-09', engagements: 0, likes: 0, replies: 0, rts: 0, lastInteraction: null },
      { handle: 'oldcryptoproject', name: 'Dead Coin', followsBack: false, followedSince: '2019-12', engagements: 0, likes: 0, replies: 0, rts: 0, lastInteraction: null },
    ];

    // Navigate
    function goToPage(num) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page' + num).classList.add('active');
      currentPage = num;
    }

    function showLoading(handle) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('loadingPage').classList.add('active');
      document.getElementById('loadingHandle').textContent = handle;
    }

    function formatNum(n) {
      if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n/1000).toFixed(1) + 'K';
      return n.toString();
    }

    // Logo click - restart
    document.getElementById('logoBtn').addEventListener('click', function() {
      goToPage(1);
    });

    // Page 2: Upload zone - real file upload with archive parsing

    // Individual files state for privacy-first option
    var individualFiles = {
      following: null,
      follower: null,
      like: null,
      tweets: null
    };

    var uploadZoneFiles = document.getElementById('uploadZoneFiles');
    var fileInputMultiple = document.createElement('input');
    fileInputMultiple.type = 'file';
    fileInputMultiple.multiple = true;
    fileInputMultiple.accept = '.js,.json';
    fileInputMultiple.style.display = 'none';
    document.body.appendChild(fileInputMultiple);

    uploadZoneFiles.addEventListener('click', function() {
      fileInputMultiple.click();
    });

    uploadZoneFiles.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.style.borderColor = 'var(--green)';
      this.style.background = 'var(--green-dim)';
    });

    uploadZoneFiles.addEventListener('dragleave', function(e) {
      e.preventDefault();
      this.style.borderColor = '';
      this.style.background = '';
    });

    uploadZoneFiles.addEventListener('drop', function(e) {
      e.preventDefault();
      this.style.borderColor = '';
      this.style.background = '';
      handleIndividualFiles(e.dataTransfer.files);
    });

    fileInputMultiple.addEventListener('change', function() {
      handleIndividualFiles(this.files);
    });

    function handleIndividualFiles(files) {
      for (var i = 0; i < files.length; i++) {
        var file = files[i];
        var name = file.name.toLowerCase();
        
        if (name === 'following.js' || name === 'following.json') individualFiles.following = file;
        else if (name === 'follower.js' || name === 'follower.json' || name === 'followers.json') individualFiles.follower = file;
        else if (name === 'like.js' || name === 'like.json' || name === 'likes.json') individualFiles.like = file;
        else if (name === 'tweets.js' || name === 'tweets.json') individualFiles.tweets = file;
      }
      updateFileStatus();
    }

    function updateFileStatus() {
      var count = 0;
      
      if (individualFiles.following) {
        document.getElementById('statusFollowing').textContent = '‚úì';
        document.getElementById('statusFollowing').style.borderColor = 'var(--success)';
        document.getElementById('statusFollowing').style.color = 'var(--success)';
        count++;
      }
      if (individualFiles.follower) {
        document.getElementById('statusFollower').textContent = '‚úì';
        document.getElementById('statusFollower').style.borderColor = 'var(--success)';
        document.getElementById('statusFollower').style.color = 'var(--success)';
        count++;
      }
      if (individualFiles.like) {
        document.getElementById('statusLike').textContent = '‚úì';
        document.getElementById('statusLike').style.borderColor = 'var(--success)';
        document.getElementById('statusLike').style.color = 'var(--success)';
        count++;
      }
      if (individualFiles.tweets) {
        document.getElementById('statusTweets').textContent = '‚úì';
        document.getElementById('statusTweets').style.borderColor = 'var(--success)';
        document.getElementById('statusTweets').style.color = 'var(--success)';
        count++;
      }
      
      document.getElementById('filesReadyCount').textContent = '(' + count + '/4 ready)';
      document.getElementById('processFilesBtn').disabled = count < 2; // Need at least following + one engagement file
    }

    document.getElementById('processFilesBtn').addEventListener('click', function() {
      processIndividualFiles();
    });

    async function processIndividualFiles() {
      const info = document.getElementById('processingInfo');
      const progress = document.getElementById('uploadProgress');
      const status = document.getElementById('uploadStatus');

      info.classList.add('active');
      progress.style.width = '10%';
      status.textContent = 'Processing files...';

      try {
        var followingData = [];
        var followerData = [];
        var likeData = [];
        var tweetsData = [];

        if (individualFiles.following) {
          progress.style.width = '20%';
          status.textContent = 'Reading following...';
          var content = await individualFiles.following.text();
          followingData = parseTwitterJS(content);
        }

        if (individualFiles.follower) {
          progress.style.width = '35%';
          status.textContent = 'Reading followers...';
          var content = await individualFiles.follower.text();
          followerData = parseTwitterJS(content);
        }

        if (individualFiles.like) {
          progress.style.width = '50%';
          status.textContent = 'Reading likes...';
          var content = await individualFiles.like.text();
          likeData = parseTwitterJS(content);
          console.log('Like data loaded:', likeData.length, 'items');
          console.log('First like item:', JSON.stringify(likeData[0], null, 2));
        }

        if (individualFiles.tweets) {
          progress.style.width = '65%';
          status.textContent = 'Reading tweets...';
          var content = await individualFiles.tweets.text();
          tweetsData = parseTwitterJS(content);
        }

        progress.style.width = '80%';
        status.textContent = 'Analyzing engagement...';

        // Build follower set
        var followerHandles = new Set();
        followerData.forEach(function(f) {
          var handle = f.follower?.userLink?.split('/').pop()?.toLowerCase();
          if (handle) followerHandles.add(handle);
        });

        // Store ALL engagement dates per user (for lookback filtering)
        var allLikeDates = {}; // handle -> [date1, date2, ...]
        var allReplyDates = {}; // handle -> [date1, date2, ...]
        
        likeData.forEach(function(l) {
          // X changed archive format - expandedUrl no longer has username
          // Try to extract from fullText if it's a reply (starts with @username)
          var fullText = l.like?.fullText || l.fullText || '';
          var url = l.like?.expandedUrl || l.like?.fullUrl || l.expandedUrl || l.fullUrl || '';
          
          // Method 1: Try URL (old format or lucky)
          var match = url.match(/twitter\.com\/([^\/]+)\/status/i) || url.match(/x\.com\/([^\/]+)\/status/i);
          var handle = null;
          
          if (match && match[1] !== 'i' && match[1] !== 'web') {
            handle = match[1].toLowerCase();
          }
          
          // Method 2: If fullText starts with @username, it's a reply - extract the username
          if (!handle && fullText.startsWith('@')) {
            var mentionMatch = fullText.match(/^@(\w+)/);
            if (mentionMatch) {
              handle = mentionMatch[1].toLowerCase();
            }
          }
          
          if (handle && handle !== 'i' && handle !== 'web') {
            var tweetId = l.like?.tweetId || l.tweetId || '';
            var date = tweetId ? extractDateFromId(tweetId) : null;
            // Store all dates for later filtering
            if (!allLikeDates[handle]) allLikeDates[handle] = [];
            if (date) allLikeDates[handle].push(date);
          }
        });
        
        console.log('Like dates stored for', Object.keys(allLikeDates).length, 'accounts');

        // Count replies per user and collect top tweets - store ALL dates
        allTweets = [];
        
        tweetsData.forEach(function(t) {
          var tweet = t.tweet;
          var replyTo = tweet?.in_reply_to_screen_name?.toLowerCase();
          var tweetDate = tweet?.created_at ? new Date(tweet.created_at).toISOString().slice(0, 7) : null;
          
          // Store reply dates
          if (replyTo) {
            if (!allReplyDates[replyTo]) allReplyDates[replyTo] = [];
            if (tweetDate) allReplyDates[replyTo].push(tweetDate);
          }
          
          // Collect tweets for Top Tweets
          var likes = parseInt(tweet?.favorite_count) || 0;
          var retweets = parseInt(tweet?.retweet_count) || 0;
          if (likes + retweets > 0) {
            allTweets.push({
              id: tweet?.id_str || tweet?.id,
              text: tweet?.full_text || '',
              likes: likes,
              retweets: retweets,
              date: tweet?.created_at,
              dateStr: tweetDate,
              isReply: !!replyTo,
              score: likes + retweets
            });
          }
        });

        allTweets.sort(function(a, b) { return b.score - a.score; });
        
        // Store raw engagement dates globally for lookback filtering
        window.allLikeDates = allLikeDates;
        window.allReplyDates = allReplyDates;
        
        // Calculate initial counts (all time)
        var likeCounts = {};
        var lastLikeDates = {};
        Object.keys(allLikeDates).forEach(function(handle) {
          likeCounts[handle] = allLikeDates[handle].length;
          lastLikeDates[handle] = allLikeDates[handle].sort().reverse()[0] || null;
        });
        
        var replyCounts = {};
        var lastReplyDates = {};
        Object.keys(allReplyDates).forEach(function(handle) {
          replyCounts[handle] = allReplyDates[handle].length;
          lastReplyDates[handle] = allReplyDates[handle].sort().reverse()[0] || null;
        });

        // Build accounts list from following data
        // New X format uses user IDs, not handles
        allAccounts = [];
        followingData.forEach(function(f) {
          var userLink = f.following?.userLink || '';
          var accountId = f.following?.accountId || '';
          
          // Check if old format (has username) or new format (has user_id)
          var handle = null;
          var userId = null;
          var profileUrl = null;
          
          if (userLink.includes('user_id=')) {
            // New format - extract user ID
            userId = userLink.match(/user_id=(\d+)/)?.[1] || accountId;
            profileUrl = 'https://twitter.com/intent/user?user_id=' + userId;
            handle = 'user_id=' + userId; // Use as identifier
          } else {
            // Old format - extract handle
            handle = userLink.split('/').pop()?.toLowerCase();
            profileUrl = 'https://x.com/' + handle;
          }
          
          if (handle || userId) {
            var identifier = handle || ('user_id=' + userId);
            var likes = likeCounts[identifier] || likeCounts[handle] || 0;
            var replies = replyCounts[identifier] || replyCounts[handle] || 0;
            var lastLike = lastLikeDates[identifier] || lastLikeDates[handle];
            var lastReply = lastReplyDates[identifier] || lastReplyDates[handle];
            var lastEngaged = null;
            if (lastLike && lastReply) lastEngaged = lastLike > lastReply ? lastLike : lastReply;
            else lastEngaged = lastLike || lastReply;

            allAccounts.push({
              handle: identifier,
              userId: userId,
              name: userId ? ('ID: ' + userId.slice(-8)) : handle,
              profileUrl: profileUrl,
              followsBack: followerHandles.has(identifier) || followerHandles.has(handle),
              likes: likes,
              replies: replies,
              engagements: likes + replies,
              lastEngaged: lastEngaged
            });
          }
        });
        
        // Build "Your People" from engagement data (handles we actually have)
        var engagedPeople = [];
        var seenHandles = new Set();
        
        // Add from replies
        Object.keys(replyCounts).forEach(function(handle) {
          if (!seenHandles.has(handle) && !handle.startsWith('user_id=')) {
            seenHandles.add(handle);
            var likes = likeCounts[handle] || 0;
            var replies = replyCounts[handle] || 0;
            var lastLike = lastLikeDates[handle];
            var lastReply = lastReplyDates[handle];
            var lastEngaged = null;
            if (lastLike && lastReply) lastEngaged = lastLike > lastReply ? lastLike : lastReply;
            else lastEngaged = lastLike || lastReply;
            
            engagedPeople.push({
              handle: handle,
              name: handle,
              profileUrl: 'https://x.com/' + handle,
              likes: likes,
              replies: replies,
              engagements: likes + replies,
              lastEngaged: lastEngaged
            });
          }
        });
        
        // Add from likes (only if not already added)
        Object.keys(likeCounts).forEach(function(handle) {
          if (!seenHandles.has(handle) && !handle.startsWith('user_id=')) {
            seenHandles.add(handle);
            var likes = likeCounts[handle] || 0;
            var replies = replyCounts[handle] || 0;
            var lastLike = lastLikeDates[handle];
            var lastReply = lastReplyDates[handle];
            var lastEngaged = null;
            if (lastLike && lastReply) lastEngaged = lastLike > lastReply ? lastLike : lastReply;
            else lastEngaged = lastLike || lastReply;
            
            engagedPeople.push({
              handle: handle,
              name: handle,
              profileUrl: 'https://x.com/' + handle,
              likes: likes,
              replies: replies,
              engagements: likes + replies,
              lastEngaged: lastEngaged
            });
          }
        });
        
        engagedPeople.sort(function(a, b) { return b.engagements - a.engagements; });

        allAccounts.sort(function(a, b) { return b.engagements - a.engagements; });
        
        // Store engagedPeople globally for rendering
        window.engagedPeople = engagedPeople;
        
        // Store counts globally for recalculation after handle resolution
        window.likeCounts = likeCounts;
        window.replyCounts = replyCounts;
        window.lastLikeDates = lastLikeDates;
        window.lastReplyDates = lastReplyDates;

        progress.style.width = '100%';
        status.textContent = 'Complete!';

        await new Promise(function(r) { setTimeout(r, 500); });

        var deadAccounts = allAccounts.filter(function(a) { return a.engagements === 0; });

        document.getElementById('deadCount').textContent = deadAccounts.length;
        document.getElementById('peopleCount').textContent = engagedPeople.length;
        document.getElementById('totalDeadCount').textContent = deadAccounts.length;
        document.getElementById('totalPeopleCount').textContent = engagedPeople.length;
        document.getElementById('topTweetsCount2').textContent = Math.min(allTweets.length, 50);
        document.getElementById('mentionsCount2').textContent = allMentions.length;

        document.getElementById('page1').classList.remove('active');
        document.getElementById('page2').classList.add('active');
        window.scrollTo(0, 0);
        
        showResultsOrListSetup();
        
        // Apply any cached handles and check if resolve prompt needed
        applyCachedHandles();
        checkShowResolvePrompt();

        renderDeadList();
        renderPeopleList();
        renderTopTweets();
        renderMentionsList();

      } catch (err) {
        console.error('Error processing files:', err);
        status.textContent = 'Error: ' + err.message;
        progress.style.background = 'var(--danger)';
      }
    }

    function extractDateFromId(tweetId) {
      try {
        var id = BigInt(tweetId);
        var timestamp = Number(id >> 22n) + 1288834974657;
        var date = new Date(timestamp);
        return date.toISOString().slice(0, 7);
      } catch (e) {
        return null;
      }
    }

    // Full zip upload (also handles combined JSON from Community Archive)
    var uploadZone = document.getElementById('uploadZone');
    var fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.zip,.json';
    fileInput.style.display = 'none';
    document.body.appendChild(fileInput);

    uploadZone.addEventListener('click', function() {
      fileInput.click();
    });

    uploadZone.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.style.borderColor = 'var(--green)';
      this.style.background = 'var(--green-dim)';
    });

    uploadZone.addEventListener('dragleave', function(e) {
      e.preventDefault();
      this.style.borderColor = '';
      this.style.background = '';
    });

    uploadZone.addEventListener('drop', function(e) {
      e.preventDefault();
      this.style.borderColor = '';
      this.style.background = '';
      if (e.dataTransfer.files.length > 0) {
        var file = e.dataTransfer.files[0];
        if (file.name.endsWith('.json')) {
          processCommunityArchive(file);
        } else {
          processArchive(file);
        }
      }
    });

    fileInput.addEventListener('change', function() {
      if (this.files.length > 0) {
        var file = this.files[0];
        if (file.name.endsWith('.json')) {
          processCommunityArchive(file);
        } else {
          processArchive(file);
        }
      }
    });

    // Process Community Archive combined JSON file
    async function processCommunityArchive(file) {
      const info = document.getElementById('processingInfo');
      const progress = document.getElementById('uploadProgress');
      const status = document.getElementById('uploadStatus');

      info.classList.add('active');
      progress.style.width = '10%';
      status.textContent = 'Reading Community Archive...';

      try {
        var content = await file.text();
        var data = JSON.parse(content);

        progress.style.width = '30%';
        status.textContent = 'Parsing accounts...';

        // Get username from account data
        var myUsername = data.account?.[0]?.account?.username?.toLowerCase() || '';

        // Build follower set from IDs (we'll match by ID later if needed)
        var followerIds = new Set();
        if (data.follower) {
          data.follower.forEach(function(f) {
            var id = f.follower?.accountId;
            if (id) followerIds.add(id);
          });
        }

        // Build following map - accountId -> true (we need to resolve handles from tweets)
        var followingIds = new Set();
        if (data.following) {
          data.following.forEach(function(f) {
            var id = f.following?.accountId;
            if (id) followingIds.add(id);
          });
        }

        progress.style.width = '50%';
        status.textContent = 'Analyzing tweets & mentions...';

        // 2-year cutoff
        var twoYearsAgo = new Date();
        twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
        var cutoffDate = twoYearsAgo.toISOString().slice(0, 7); // YYYY-MM format

        // Parse tweets for replies, top tweets, and mentions
        var replyCounts = {};
        var lastEngagedDates = {};
        var handleToId = {}; // Map handles to IDs from mentions
        var mentionCounts = {};
        var mentionDates = {};
        allTweets = [];

        if (data.tweets) {
          data.tweets.forEach(function(t) {
            var tweet = t.tweet;
            var replyTo = tweet?.in_reply_to_screen_name;
            var replyToId = tweet?.in_reply_to_user_id;
            var createdAt = tweet?.created_at;
            var text = tweet?.full_text || tweet?.text || '';
            var likes = parseInt(tweet?.favorite_count) || 0;
            var retweets = parseInt(tweet?.retweet_count) || 0;
            var id = tweet?.id_str || tweet?.id;
            
            // Check if within last 2 years
            var tweetDateStr = null;
            if (createdAt) {
              var date = new Date(createdAt);
              tweetDateStr = date.toISOString().slice(0, 7);
            }
            var isRecent = !tweetDateStr || tweetDateStr >= cutoffDate;

            // Skip self-replies for reply counting (only count recent)
            if (replyTo && replyTo.toLowerCase() !== myUsername && isRecent) {
              var handle = replyTo.toLowerCase();
              replyCounts[handle] = (replyCounts[handle] || 0) + 1;
              
              // Track handle to ID mapping
              if (replyToId) {
                handleToId[handle] = replyToId;
              }

              if (tweetDateStr) {
                if (!lastEngagedDates[handle] || tweetDateStr > lastEngagedDates[handle]) {
                  lastEngagedDates[handle] = tweetDateStr;
                }
              }
            }

            // Track mentions (only recent)
            if (isRecent) {
              var mentions = tweet?.entities?.user_mentions || [];
              mentions.forEach(function(m) {
                if (m.screen_name && m.id_str) {
                  var mHandle = m.screen_name.toLowerCase();
                  handleToId[mHandle] = m.id_str;
                  // Don't count self-mentions
                  if (mHandle !== myUsername) {
                    mentionCounts[mHandle] = (mentionCounts[mHandle] || 0) + 1;
                    if (tweetDateStr) {
                      if (!mentionDates[mHandle] || tweetDateStr > mentionDates[mHandle]) {
                        mentionDates[mHandle] = tweetDateStr;
                      }
                    }
                  }
                }
              });
            }
            
            // Collect tweets for top tweets (exclude pure retweets, only recent)
            if (!text.startsWith('RT @') && isRecent) {
              allTweets.push({
                id: id,
                text: text,
                likes: likes,
                retweets: retweets,
                score: likes + retweets,
                date: createdAt,
                isReply: !!replyTo
              });
            }
          });
        }
        
        // Sort tweets by score
        allTweets.sort(function(a, b) { return b.score - a.score; });
        
        // Build mentions list
        allMentions = Object.keys(mentionCounts).map(function(handle) {
          return {
            handle: handle,
            mentions: mentionCounts[handle],
            replies: replyCounts[handle] || 0,
            lastMentioned: mentionDates[handle] || null
          };
        });
        allMentions.sort(function(a, b) { return b.mentions - a.mentions; });

        progress.style.width = '70%';
        status.textContent = 'Building account list...';

        // Build accounts list from handles we know
        // We can only include accounts we've interacted with (replied to or mentioned)
        var knownHandles = Object.keys(replyCounts);
        
        allAccounts = knownHandles.map(function(handle) {
          var id = handleToId[handle];
          var followsBack = id ? followerIds.has(id) : false;
          var replies = replyCounts[handle] || 0;
          return {
            handle: handle,
            name: handle,
            followsBack: followsBack,
            followedSince: null,
            engagements: replies,
            likes: 0, // Can't determine from Community Archive format
            replies: replies,
            lastEngaged: lastEngagedDates[handle] || null
          };
        });

        // Sort by engagement
        allAccounts.sort(function(a, b) { return b.engagements - a.engagements; });

        progress.style.width = '100%';
        status.textContent = 'Complete!';

        await new Promise(function(r) { setTimeout(r, 500); });

        // Setup results
        var deadAccounts = allAccounts.filter(function(a) { return a.engagements === 0; });
        var engagedAccounts = allAccounts.filter(function(a) { return a.engagements > 0; });

        document.getElementById('deadCount').textContent = deadAccounts.length;
        document.getElementById('peopleCount').textContent = engagedAccounts.length;
        document.getElementById('totalDeadCount').textContent = deadAccounts.length;
        document.getElementById('totalPeopleCount').textContent = engagedAccounts.length;
        document.getElementById('topTweetsCount2').textContent = Math.min(allTweets.length, 50);
        document.getElementById('mentionsCount2').textContent = allMentions.length;

        // Switch to results page
        document.getElementById('page1').classList.remove('active');
        document.getElementById('page2').classList.add('active');
        window.scrollTo(0, 0);
        
        showResultsOrListSetup();

        renderDeadList();
        renderPeopleList();
        renderTopTweets();
        renderMentionsList();

      } catch (err) {
        console.error('Error processing Community Archive:', err);
        status.textContent = 'Error: ' + err.message;
        progress.style.background = 'var(--danger)';
      }
    }

    async function processArchive(file) {
      const info = document.getElementById('processingInfo');
      const progress = document.getElementById('uploadProgress');
      const status = document.getElementById('uploadStatus');

      info.classList.add('active');
      progress.style.width = '10%';
      status.textContent = 'Reading archive...';

      try {
        // Load JSZip dynamically
        if (typeof JSZip === 'undefined') {
          await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js');
        }

        progress.style.width = '20%';
        status.textContent = 'Extracting files...';

        const zip = await JSZip.loadAsync(file);
        
        progress.style.width = '30%';
        status.textContent = 'Parsing following list...';

        // Parse following
        var following = [];
        var followingFile = zip.file(/following\.js$/i)[0];
        if (followingFile) {
          var followingContent = await followingFile.async('string');
          var followingData = parseTwitterJS(followingContent);
          following = followingData.map(function(f) {
            var link = f.following?.userLink || '';
            var handle = link.split('/').pop();
            return handle;
          }).filter(Boolean);
        }

        progress.style.width = '40%';
        status.textContent = 'Parsing followers...';

        // Parse followers
        var followers = [];
        var followerFile = zip.file(/follower\.js$/i)[0];
        if (followerFile) {
          var followerContent = await followerFile.async('string');
          var followerData = parseTwitterJS(followerContent);
          followers = followerData.map(function(f) {
            var link = f.follower?.userLink || '';
            var handle = link.split('/').pop();
            return handle;
          }).filter(Boolean);
        }
        var followerSet = new Set(followers);

        progress.style.width = '60%';
        status.textContent = 'Analyzing likes...';

        // 2-year cutoff
        var twoYearsAgo = new Date();
        twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
        var cutoffDate = twoYearsAgo.toISOString().slice(0, 7); // YYYY-MM format

        // Parse likes - store ALL dates for lookback filtering
        var allLikeDates = {}; // handle -> [date1, date2, ...]
        var allReplyDates = {}; // handle -> [date1, date2, ...]
        var lastEngagedDates = {};
        
        var likeFile = zip.file(/like\.js$/i)[0];
        if (likeFile) {
          var likeContent = await likeFile.async('string');
          var likeData = parseTwitterJS(likeContent);
          likeData.forEach(function(l) {
            // X changed archive format - expandedUrl no longer has username
            var fullText = l.like?.fullText || l.fullText || '';
            var url = l.like?.expandedUrl || '';
            
            // Method 1: Try URL (old format)
            var match = url.match(/x\.com\/([^\/]+)\/status/i) || url.match(/twitter\.com\/([^\/]+)\/status/i);
            var handle = null;
            
            if (match && match[1] !== 'i' && match[1] !== 'web') {
              handle = match[1].toLowerCase();
            }
            
            // Method 2: If fullText starts with @username, extract it
            if (!handle && fullText.startsWith('@')) {
              var mentionMatch = fullText.match(/^@(\w+)/);
              if (mentionMatch) {
                handle = mentionMatch[1].toLowerCase();
              }
            }
            
            if (handle && handle !== 'i' && handle !== 'web') {
              var date = l.like?.tweetId ? extractDateFromId(l.like.tweetId) : null;
              // Store ALL dates for lookback filtering
              if (!allLikeDates[handle]) allLikeDates[handle] = [];
              if (date) allLikeDates[handle].push(date);
            }
          });
        }

        progress.style.width = '80%';
        status.textContent = 'Processing tweets & mentions...';

        // Parse tweets for replies, top tweets, and mentions - store ALL dates
        var mentionCounts = {};
        var mentionDates = {};
        allTweets = [];
        
        var tweetsFile = zip.file(/tweets\.js$/i)[0];
        if (tweetsFile) {
          var tweetsContent = await tweetsFile.async('string');
          var tweetsData = parseTwitterJS(tweetsContent);
          tweetsData.forEach(function(t) {
            var tweet = t.tweet;
            var replyTo = tweet?.in_reply_to_screen_name;
            var createdAt = tweet?.created_at;
            var text = tweet?.full_text || tweet?.text || '';
            var likes = parseInt(tweet?.favorite_count) || 0;
            var retweets = parseInt(tweet?.retweet_count) || 0;
            var id = tweet?.id_str || tweet?.id;
            
            var tweetDateStr = null;
            if (createdAt) {
              var date = new Date(createdAt);
              tweetDateStr = date.toISOString().slice(0, 7);
            }
            
            // Store ALL reply dates for lookback filtering
            if (replyTo) {
              var handle = replyTo.toLowerCase();
              if (!allReplyDates[handle]) allReplyDates[handle] = [];
              if (tweetDateStr) allReplyDates[handle].push(tweetDateStr);
            }
            
            // Track mentions (all time for now)
            var mentions = tweet?.entities?.user_mentions || [];
            mentions.forEach(function(m) {
              if (m.screen_name) {
                var mHandle = m.screen_name.toLowerCase();
                mentionCounts[mHandle] = (mentionCounts[mHandle] || 0) + 1;
                if (tweetDateStr) {
                  if (!mentionDates[mHandle] || tweetDateStr > mentionDates[mHandle]) {
                    mentionDates[mHandle] = tweetDateStr;
                  }
                }
              }
            });
            
            // Collect ALL tweets for top tweets (exclude pure retweets)
            if (!text.startsWith('RT @')) {
              allTweets.push({
                id: id,
                text: text,
                likes: likes,
                retweets: retweets,
                score: likes + retweets,
                date: createdAt,
                dateStr: tweetDateStr,
                isReply: !!replyTo
              });
            }
          });
        }
        
        // Sort tweets by score
        allTweets.sort(function(a, b) { return b.score - a.score; });
        
        // Store raw engagement dates globally for lookback filtering
        window.allLikeDates = allLikeDates;
        window.allReplyDates = allReplyDates;
        
        // Calculate initial counts (all time)
        var likeCounts = {};
        var lastLikeDates = {};
        Object.keys(allLikeDates).forEach(function(handle) {
          likeCounts[handle] = allLikeDates[handle].length;
          var sorted = allLikeDates[handle].slice().sort().reverse();
          lastLikeDates[handle] = sorted[0] || null;
        });
        
        var replyCounts = {};
        var lastReplyDates = {};
        Object.keys(allReplyDates).forEach(function(handle) {
          replyCounts[handle] = allReplyDates[handle].length;
          var sorted = allReplyDates[handle].slice().sort().reverse();
          lastReplyDates[handle] = sorted[0] || null;
        });
        
        // Store counts globally
        window.likeCounts = likeCounts;
        window.replyCounts = replyCounts;
        window.lastLikeDates = lastLikeDates;
        window.lastReplyDates = lastReplyDates;
        
        // Build mentions list
        allMentions = Object.keys(mentionCounts).map(function(handle) {
          return {
            handle: handle,
            mentions: mentionCounts[handle],
            replies: replyCounts[handle] || 0,
            lastMentioned: mentionDates[handle] || null
          };
        });
        allMentions.sort(function(a, b) { return b.mentions - a.mentions; });

        progress.style.width = '90%';
        status.textContent = 'Building report...';

        // Build accounts list
        allAccounts = following.map(function(handle) {
          var h = handle.toLowerCase();
          var likes = likeCounts[h] || 0;
          var replies = replyCounts[h] || 0;
          var lastLike = lastLikeDates[h];
          var lastReply = lastReplyDates[h];
          var lastEngaged = null;
          if (lastLike && lastReply) lastEngaged = lastLike > lastReply ? lastLike : lastReply;
          else lastEngaged = lastLike || lastReply;
          
          return {
            handle: handle,
            name: handle,
            followsBack: followerSet.has(handle),
            followedSince: null,
            engagements: likes + replies,
            likes: likes,
            replies: replies,
            lastEngaged: lastEngaged
          };
        });
        
        // Build engaged people list
        var seenHandles = new Set(following.map(function(h) { return h.toLowerCase(); }));
        var engagedPeople = [];
        
        Object.keys(replyCounts).forEach(function(handle) {
          if (!seenHandles.has(handle)) {
            seenHandles.add(handle);
            var likes = likeCounts[handle] || 0;
            var replies = replyCounts[handle] || 0;
            var lastLike = lastLikeDates[handle];
            var lastReply = lastReplyDates[handle];
            var lastEngaged = null;
            if (lastLike && lastReply) lastEngaged = lastLike > lastReply ? lastLike : lastReply;
            else lastEngaged = lastLike || lastReply;
            
            engagedPeople.push({
              handle: handle,
              name: handle,
              profileUrl: 'https://x.com/' + handle,
              likes: likes,
              replies: replies,
              engagements: likes + replies,
              lastEngaged: lastEngaged
            });
          }
        });
        
        Object.keys(likeCounts).forEach(function(handle) {
          if (!seenHandles.has(handle)) {
            seenHandles.add(handle);
            var likes = likeCounts[handle] || 0;
            var replies = replyCounts[handle] || 0;
            var lastLike = lastLikeDates[handle];
            var lastReply = lastReplyDates[handle];
            var lastEngaged = null;
            if (lastLike && lastReply) lastEngaged = lastLike > lastReply ? lastLike : lastReply;
            else lastEngaged = lastLike || lastReply;
            
            engagedPeople.push({
              handle: handle,
              name: handle,
              profileUrl: 'https://x.com/' + handle,
              likes: likes,
              replies: replies,
              engagements: likes + replies,
              lastEngaged: lastEngaged
            });
          }
        });
        
        engagedPeople.sort(function(a, b) { return b.engagements - a.engagements; });
        window.engagedPeople = engagedPeople;

        progress.style.width = '100%';
        status.textContent = 'Complete!';

        await new Promise(function(r) { setTimeout(r, 500); });

        // Setup results
        var deadAccounts = allAccounts.filter(function(a) { return a.engagements === 0; });

        // Update counts
        document.getElementById('deadCount').textContent = deadAccounts.length;
        document.getElementById('peopleCount').textContent = engagedPeople.length;
        document.getElementById('totalDeadCount').textContent = deadAccounts.length;
        document.getElementById('totalPeopleCount').textContent = engagedPeople.length;
        document.getElementById('topTweetsCount2').textContent = Math.min(allTweets.length, 50);
        document.getElementById('mentionsCount2').textContent = allMentions.length;

        // Switch to results page
        document.getElementById('page1').classList.remove('active');
        document.getElementById('page2').classList.add('active');
        window.scrollTo(0, 0);
        
        showResultsOrListSetup();

        renderDeadList();
        renderPeopleList();
        renderTopTweets();
        renderMentionsList();

      } catch (err) {
        console.error('Error processing archive:', err);
        status.textContent = 'Error: ' + err.message;
        progress.style.background = 'var(--danger)';
      }
    }

    // Helper to parse Twitter's JS format (window.YTD.xxx.part0 = [...])
    function parseTwitterJS(content) {
      try {
        // Remove the window.YTD.xxx.part0 = prefix
        var jsonStart = content.indexOf('[');
        var jsonEnd = content.lastIndexOf(']') + 1;
        var jsonStr = content.slice(jsonStart, jsonEnd);
        return JSON.parse(jsonStr);
      } catch (e) {
        console.error('Parse error:', e);
        return [];
      }
    }

    // Helper to load script dynamically
    function loadScript(src) {
      return new Promise(function(resolve, reject) {
        var script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }

    // Generate consistent gradient for avatar based on handle
    function getAvatarGradient(handle) {
      var gradients = [
        'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
        'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
        'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
        'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
        'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
        'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
        'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
        'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
        'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)',
        'linear-gradient(135deg, #cd9cf2 0%, #f6f3ff 100%)',
        'linear-gradient(135deg, #37ecba 0%, #72afd3 100%)',
        'linear-gradient(135deg, #c471f5 0%, #fa71cd 100%)'
      ];
      var hash = 0;
      for (var i = 0; i < handle.length; i++) {
        hash = handle.charCodeAt(i) + ((hash << 5) - hash);
      }
      return gradients[Math.abs(hash) % gradients.length];
    }

    // State
    var currentTab = 'people';
    var deadSort = { field: 'lastEngaged', direction: 'desc' };
    var peopleSort = { field: 'engagements', direction: 'desc' };
    var deadFilter = 'zero';
    var peopleFilter = 'all';

    // Tab switching
    document.querySelectorAll('.main-tab').forEach(function(tab) {
      tab.addEventListener('click', function() {
        currentTab = this.dataset.tab;
        document.querySelectorAll('.main-tab').forEach(function(t) {
          t.classList.remove('active');
          t.style.borderBottomColor = 'transparent';
          t.style.color = 'var(--gray)';
        });
        this.classList.add('active');
        this.style.borderBottomColor = currentTab === 'dead' ? 'var(--danger)' : 'var(--success)';
        this.style.color = 'var(--cream)';
        
        document.getElementById('deadSection').style.display = currentTab === 'dead' ? 'block' : 'none';
        document.getElementById('peopleSection').style.display = currentTab === 'people' ? 'block' : 'none';
      });
    });

    function renderDeadList() {
      var filtered;
      
      if (deadFilter === 'zero') {
        filtered = allAccounts.filter(function(a) { return a.engagements === 0; });
      } else if (deadFilter === 'noFollowBack') {
        filtered = allAccounts.filter(function(a) { return !a.followsBack; });
      } else {
        filtered = allAccounts.slice();
      }

      var search = document.getElementById('searchInputDead').value.toLowerCase();
      if (search) {
        filtered = filtered.filter(function(a) {
          return a.handle.toLowerCase().indexOf(search) !== -1 || 
                 a.name.toLowerCase().indexOf(search) !== -1;
        });
      }

      filtered.sort(function(a, b) {
        var aVal, bVal, field = deadSort.field;
        if (field === 'name') { aVal = a.name.toLowerCase(); bVal = b.name.toLowerCase(); }
        else if (field === 'followsBack') { aVal = a.followsBack ? 1 : 0; bVal = b.followsBack ? 1 : 0; }
        else if (field === 'lastEngaged') { aVal = a.lastEngaged || '0000-00'; bVal = b.lastEngaged || '0000-00'; }
        else if (field === 'engagements') { aVal = a.engagements; bVal = b.engagements; }
        else if (field === 'likes') { aVal = a.likes; bVal = b.likes; }
        else if (field === 'replies') { aVal = a.replies; bVal = b.replies; }
        else return 0;
        if (aVal < bVal) return deadSort.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return deadSort.direction === 'asc' ? 1 : -1;
        return 0;
      });

      var list = document.getElementById('deadList');
      var html = '';
      for (var i = 0; i < filtered.length; i++) {
        var a = filtered[i];
        var lastEng = a.lastEngaged ? a.lastEngaged.replace('-', '/') : 'Never';
        var lastEngClass = a.lastEngaged ? '' : 'color: var(--danger);';
        var engColor = a.engagements === 0 ? 'var(--danger)' : 'var(--dark)';
        var displayName = a.userId ? ('ID: ...' + a.userId.slice(-6)) : ('@' + a.handle);
        var profileUrl = a.profileUrl || ('https://x.com/' + a.handle);
        
        html += '<div class="table-row">' +
          '<div class="cell cell-check"><input type="checkbox" class="done-checkbox done-checkbox-dead" data-handle="' + (a.profileUrl || a.handle) + '"></div>' +
          '<div class="cell cell-account"><div class="avatar" style="background:' + getAvatarGradient(a.handle) + '; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; font-size:14px;">' + displayName.charAt(0).toUpperCase() + '</div><div class="account-info"><strong>' + displayName + '</strong></div></div>' +
          '<div class="cell cell-date" style="' + lastEngClass + '">' + lastEng + '</div>' +
          '<div class="cell cell-num" style="color:' + engColor + ';font-weight:600">' + a.engagements + '</div>' +
          '<div class="cell cell-action"><a href="' + profileUrl + '" target="_blank" class="action-link">Visit</a></div>' +
          '</div>';
      }
      list.innerHTML = html;

      document.getElementById('totalDeadCount').textContent = filtered.length;
      document.getElementById('selectAllDead').checked = false;
    }

    function renderPeopleList() {
      var engagedPeople = window.engagedPeople || [];
      var filtered = engagedPeople.slice();
      
      // Get minimum engagement filter
      var minEngagementEl = document.getElementById('minEngagementFilter');
      var minEngagement = minEngagementEl ? parseInt(minEngagementEl.value, 10) : 1;
      
      // Store unfiltered total
      var unfilteredTotal = filtered.length;
      
      // Filter by minimum engagements
      filtered = filtered.filter(function(a) {
        return a.engagements >= minEngagement;
      });

      var search = document.getElementById('searchInputPeople').value.toLowerCase();
      if (search) {
        filtered = filtered.filter(function(a) {
          return a.handle.toLowerCase().indexOf(search) !== -1 || 
                 a.name.toLowerCase().indexOf(search) !== -1;
        });
      }

      filtered.sort(function(a, b) {
        var aVal, bVal, field = peopleSort.field;
        if (field === 'name') { aVal = a.name.toLowerCase(); bVal = b.name.toLowerCase(); }
        else if (field === 'lastEngaged') { aVal = a.lastEngaged || '0000-00'; bVal = b.lastEngaged || '0000-00'; }
        else if (field === 'engagements') { aVal = a.engagements; bVal = b.engagements; }
        else return 0;
        if (aVal < bVal) return peopleSort.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return peopleSort.direction === 'asc' ? 1 : -1;
        return 0;
      });

      var list = document.getElementById('peopleList');
      var html = '';
      for (var i = 0; i < filtered.length; i++) {
        var a = filtered[i];
        var lastEng = a.lastEngaged ? a.lastEngaged.replace('-', '/') : '‚Äî';
        var profileUrl = a.profileUrl || ('https://x.com/' + a.handle);
        
        html += '<div class="table-row">' +
          '<div class="cell cell-check"><input type="checkbox" class="done-checkbox done-checkbox-people" data-handle="' + a.handle + '"></div>' +
          '<div class="cell cell-account"><div class="avatar" style="background:' + getAvatarGradient(a.handle) + '; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; font-size:14px;">' + a.handle.charAt(0).toUpperCase() + '</div><div class="account-info"><strong>@' + a.handle + '</strong></div></div>' +
          '<div class="cell cell-date">' + lastEng + '</div>' +
          '<div class="cell cell-num" style="color:var(--success);font-weight:600">' + a.engagements + '</div>' +
          '<div class="cell cell-action"><a href="' + profileUrl + '" target="_blank" class="action-link action-link-success">Visit</a></div>' +
          '</div>';
      }
      list.innerHTML = html;

      document.getElementById('totalPeopleCount').textContent = filtered.length;
      document.getElementById('peopleCount').textContent = filtered.length; // Update tab count too
      var unfilteredEl = document.getElementById('totalPeopleUnfiltered');
      if (unfilteredEl) unfilteredEl.textContent = unfilteredTotal;
      document.getElementById('selectAllPeople').checked = false;
    }

    // Tweets filter state
    var tweetsFilter = 'all';
    var tweetsSearch = '';

    function renderTopTweets() {
      var filtered = allTweets.slice();
      
      if (tweetsFilter === 'original') {
        filtered = filtered.filter(function(t) { return !t.isReply; });
      } else if (tweetsFilter === 'replies') {
        filtered = filtered.filter(function(t) { return t.isReply; });
      }

      var search = document.getElementById('searchInputTweets').value.toLowerCase();
      if (search) {
        filtered = filtered.filter(function(t) {
          return t.text.toLowerCase().indexOf(search) !== -1;
        });
      }

      // Already sorted by score (likes + RTs) descending
      var list = document.getElementById('topTweetsList');
      var html = '';
      
      // Show top 50
      var toShow = filtered.slice(0, 50);
      
      for (var i = 0; i < toShow.length; i++) {
        var t = toShow[i];
        var dateStr = t.date ? new Date(t.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
        var displayText = t.text.replace(/https?:\/\/t\.co\/\w+/g, function(url) {
          return '<a href="' + url + '" target="_blank">' + url + '</a>';
        });
        
        html += '<div class="tweet-card">' +
          '<div class="tweet-header">' +
            '<span style="font-size:12px;color:var(--gray);">#' + (i + 1) + '</span>' +
            (t.isReply ? '<span style="font-size:11px;color:var(--green);background:rgba(34,211,238,0.15);padding:2px 8px;border-radius:4px;">Reply</span>' : '') +
            '<span class="tweet-date">' + dateStr + '</span>' +
          '</div>' +
          '<div class="tweet-text">' + displayText + '</div>' +
          '<div class="tweet-stats">' +
            '<div class="tweet-stat">‚ù§Ô∏è <span>' + t.likes + '</span></div>' +
            '<div class="tweet-stat">üîÅ <span>' + t.retweets + '</span></div>' +
            '<div class="tweet-link"><a href="https://x.com/i/status/' + t.id + '" target="_blank">View ‚Üí</a></div>' +
          '</div>' +
        '</div>';
      }
      
      if (toShow.length === 0) {
        html = '<div style="text-align:center;padding:40px;color:var(--gray);">No tweets found</div>';
      }
      
      list.innerHTML = html;
    }

    // Mentions sort state
    var mentionsSort = { field: 'mentions', direction: 'desc' };

    function renderMentionsList() {
      var filtered = allMentions.slice();

      var search = document.getElementById('searchInputMentions').value.toLowerCase();
      if (search) {
        filtered = filtered.filter(function(m) {
          return m.handle.toLowerCase().indexOf(search) !== -1;
        });
      }

      filtered.sort(function(a, b) {
        var aVal, bVal, field = mentionsSort.field;
        if (field === 'mentions') { aVal = a.mentions; bVal = b.mentions; }
        else if (field === 'replies') { aVal = a.replies; bVal = b.replies; }
        else if (field === 'lastMentioned') { aVal = a.lastMentioned || '0000-00'; bVal = b.lastMentioned || '0000-00'; }
        else return 0;
        if (aVal < bVal) return mentionsSort.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return mentionsSort.direction === 'asc' ? 1 : -1;
        return 0;
      });

      var list = document.getElementById('mentionsList');
      var html = '';
      
      for (var i = 0; i < filtered.length; i++) {
        var m = filtered[i];
        var lastMen = m.lastMentioned ? m.lastMentioned.replace('-', '/') : '‚Äî';
        
        html += '<div class="table-row">' +
          '<div class="cell cell-account"><a href="https://x.com/' + m.handle + '" target="_blank" style="display:flex;align-items:center;gap:10px;text-decoration:none;color:inherit;"><div class="avatar" style="background:' + getAvatarGradient(m.handle) + '; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; font-size:14px;">' + m.handle.charAt(0).toUpperCase() + '</div><div class="account-info"><strong>@' + m.handle + '</strong></div></a></div>' +
          '<div class="cell cell-num" style="color:var(--green);font-weight:600">' + m.mentions + '</div>' +
          '<div class="cell cell-num">' + m.replies + '</div>' +
          '<div class="cell cell-date">' + lastMen + '</div>' +
        '</div>';
      }
      
      if (filtered.length === 0) {
        html = '<div style="text-align:center;padding:40px;color:var(--gray);">No mentions found</div>';
      }
      
      list.innerHTML = html;
    }

    // Filter tabs for dead section
    document.getElementById('filterTabsDead').addEventListener('click', function(e) {
      if (e.target.classList.contains('filter-tab')) {
        this.querySelectorAll('.filter-tab').forEach(function(t) { t.classList.remove('active'); });
        e.target.classList.add('active');
        deadFilter = e.target.dataset.filter;
        renderDeadList();
      }
    });

    // Filter tabs for tweets section
    document.getElementById('filterTabsTweets').addEventListener('click', function(e) {
      if (e.target.classList.contains('filter-tab')) {
        this.querySelectorAll('.filter-tab').forEach(function(t) { t.classList.remove('active'); });
        e.target.classList.add('active');
        tweetsFilter = e.target.dataset.filter;
        renderTopTweets();
      }
    });

    // Search for tweets
    document.getElementById('searchInputTweets').addEventListener('input', function() {
      renderTopTweets();
    });

    // Search for mentions
    document.getElementById('searchInputMentions').addEventListener('input', function() {
      renderMentionsList();
    });

    // Column header sorting for mentions table
    document.getElementById('mentionsTableHeader').addEventListener('click', function(e) {
      var th = e.target.closest('.th.sortable');
      if (!th) return;
      
      var field = th.dataset.sort;
      if (mentionsSort.field === field) {
        mentionsSort.direction = mentionsSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        mentionsSort.field = field;
        mentionsSort.direction = 'desc';
      }
      
      // Update header UI
      this.querySelectorAll('.th.sortable').forEach(function(t) {
        t.classList.remove('active-sort', 'asc', 'desc');
        t.textContent = t.textContent.replace(' ‚Üë', '').replace(' ‚Üì', '');
      });
      th.classList.add('active-sort', mentionsSort.direction);
      th.textContent += mentionsSort.direction === 'asc' ? ' ‚Üë' : ' ‚Üì';
      
      renderMentionsList();
    });

    // Column header sorting for dead table
    document.getElementById('deadTableHeader').addEventListener('click', function(e) {
      var th = e.target.closest('.th.sortable');
      if (!th) return;
      
      var field = th.dataset.sort;
      if (deadSort.field === field) {
        deadSort.direction = deadSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        deadSort.field = field;
        deadSort.direction = 'asc';
      }
      
      // Update header UI
      this.querySelectorAll('.th.sortable').forEach(function(t) {
        t.classList.remove('active-sort', 'asc', 'desc');
        t.textContent = t.textContent.replace(' ‚Üë', '').replace(' ‚Üì', '');
      });
      th.classList.add('active-sort', deadSort.direction);
      th.textContent += deadSort.direction === 'asc' ? ' ‚Üë' : ' ‚Üì';
      
      renderDeadList();
    });

    // Column header sorting for people table
    document.getElementById('peopleTableHeader').addEventListener('click', function(e) {
      var th = e.target.closest('.th.sortable');
      if (!th) return;
      
      var field = th.dataset.sort;
      if (peopleSort.field === field) {
        peopleSort.direction = peopleSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        peopleSort.field = field;
        peopleSort.direction = 'desc'; // Default to desc for people (highest first)
      }
      
      // Update header UI
      this.querySelectorAll('.th.sortable').forEach(function(t) {
        t.classList.remove('active-sort', 'asc', 'desc');
        t.textContent = t.textContent.replace(' ‚Üë', '').replace(' ‚Üì', '');
      });
      th.classList.add('active-sort', peopleSort.direction);
      th.textContent += peopleSort.direction === 'asc' ? ' ‚Üë' : ' ‚Üì';
      
      renderPeopleList();
    });

    // Search handlers
    document.getElementById('searchInputDead').addEventListener('input', renderDeadList);
    document.getElementById('searchInputPeople').addEventListener('input', renderPeopleList);
    
    // Engagement filter handler
    document.getElementById('minEngagementFilter').addEventListener('change', renderPeopleList);
    
    // Lookback filter handler - recalculates all engagement data
    document.getElementById('lookbackFilter').addEventListener('change', function() {
      recalculateEngagementWithLookback();
    });
    
    // Recalculate engagement based on lookback period
    function recalculateEngagementWithLookback() {
      var lookbackYears = document.getElementById('lookbackFilter').value;
      var cutoffDate = null;
      
      if (lookbackYears !== 'all') {
        var cutoff = new Date();
        cutoff.setFullYear(cutoff.getFullYear() - parseInt(lookbackYears));
        cutoffDate = cutoff.toISOString().slice(0, 7); // YYYY-MM format
      }
      
      console.log('Recalculating with lookback:', lookbackYears, 'cutoff:', cutoffDate);
      
      var allLikeDates = window.allLikeDates || {};
      var allReplyDates = window.allReplyDates || {};
      
      // Recalculate likeCounts with cutoff
      var likeCounts = {};
      var lastLikeDates = {};
      Object.keys(allLikeDates).forEach(function(handle) {
        var dates = allLikeDates[handle].filter(function(d) {
          return !cutoffDate || d >= cutoffDate;
        });
        if (dates.length > 0) {
          likeCounts[handle] = dates.length;
          lastLikeDates[handle] = dates.sort().reverse()[0];
        }
      });
      
      // Recalculate replyCounts with cutoff
      var replyCounts = {};
      var lastReplyDates = {};
      Object.keys(allReplyDates).forEach(function(handle) {
        var dates = allReplyDates[handle].filter(function(d) {
          return !cutoffDate || d >= cutoffDate;
        });
        if (dates.length > 0) {
          replyCounts[handle] = dates.length;
          lastReplyDates[handle] = dates.sort().reverse()[0];
        }
      });
      
      // Update global counts
      window.likeCounts = likeCounts;
      window.replyCounts = replyCounts;
      window.lastLikeDates = lastLikeDates;
      window.lastReplyDates = lastReplyDates;
      
      // Update allAccounts engagement data
      allAccounts.forEach(function(a) {
        var handle = a.handle?.toLowerCase();
        if (handle) {
          a.likes = likeCounts[handle] || 0;
          a.replies = replyCounts[handle] || 0;
          a.engagements = a.likes + a.replies;
          var lastLike = lastLikeDates[handle];
          var lastReply = lastReplyDates[handle];
          if (lastLike && lastReply) a.lastEngaged = lastLike > lastReply ? lastLike : lastReply;
          else a.lastEngaged = lastLike || lastReply || null;
        }
      });
      
      // Rebuild engagedPeople from scratch
      var seenHandles = new Set();
      var engagedPeople = [];
      
      Object.keys(replyCounts).forEach(function(handle) {
        if (!seenHandles.has(handle)) {
          seenHandles.add(handle);
          var likes = likeCounts[handle] || 0;
          var replies = replyCounts[handle] || 0;
          var lastLike = lastLikeDates[handle];
          var lastReply = lastReplyDates[handle];
          var lastEngaged = null;
          if (lastLike && lastReply) lastEngaged = lastLike > lastReply ? lastLike : lastReply;
          else lastEngaged = lastLike || lastReply;
          
          engagedPeople.push({
            handle: handle,
            name: handle,
            profileUrl: 'https://x.com/' + handle,
            likes: likes,
            replies: replies,
            engagements: likes + replies,
            lastEngaged: lastEngaged
          });
        }
      });
      
      Object.keys(likeCounts).forEach(function(handle) {
        if (!seenHandles.has(handle)) {
          seenHandles.add(handle);
          var likes = likeCounts[handle] || 0;
          var replies = replyCounts[handle] || 0;
          var lastLike = lastLikeDates[handle];
          var lastReply = lastReplyDates[handle];
          var lastEngaged = null;
          if (lastLike && lastReply) lastEngaged = lastLike > lastReply ? lastLike : lastReply;
          else lastEngaged = lastLike || lastReply;
          
          engagedPeople.push({
            handle: handle,
            name: handle,
            profileUrl: 'https://x.com/' + handle,
            likes: likes,
            replies: replies,
            engagements: likes + replies,
            lastEngaged: lastEngaged
          });
        }
      });
      
      engagedPeople.sort(function(a, b) { return b.engagements - a.engagements; });
      window.engagedPeople = engagedPeople;
      
      // Update counts
      var deadAccounts = allAccounts.filter(function(a) { return a.engagements === 0; });
      document.getElementById('deadCount').textContent = deadAccounts.length;
      document.getElementById('peopleCount').textContent = engagedPeople.length;
      document.getElementById('totalDeadCount').textContent = deadAccounts.length;
      
      // Re-render lists
      renderDeadList();
      renderPeopleList();
      
      console.log('Recalculated: ', engagedPeople.length, 'engaged,', deadAccounts.length, 'dead');
    }

    // Helper function for clipboard with fallback
    function copyToClipboard(text) {
      return new Promise(function(resolve, reject) {
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(text).then(resolve).catch(function() {
            fallbackCopy(text, resolve, reject);
          });
        } else {
          fallbackCopy(text, resolve, reject);
        }
      });
      
      function fallbackCopy(text, resolve, reject) {
        var textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        textArea.style.top = '0';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
          var success = document.execCommand('copy');
          document.body.removeChild(textArea);
          if (success) resolve();
          else reject(new Error('execCommand failed'));
        } catch (e) {
          document.body.removeChild(textArea);
          reject(e);
        }
      }
    }

    // Copy dead weight handles (selected only)
    document.getElementById('copyDeadBtn').addEventListener('click', function() {
      var btn = this;
      var handles = [];
      document.querySelectorAll('.done-checkbox-dead:checked').forEach(function(cb) {
        handles.push('@' + cb.dataset.handle);
      });
      
      if (handles.length === 0) {
        btn.textContent = 'Select some first';
        setTimeout(function() { btn.textContent = 'Copy handles'; }, 2000);
        return;
      }
      
      copyToClipboard(handles.join('\n')).then(function() {
        btn.textContent = '‚úì Copied ' + handles.length;
        setTimeout(function() { btn.textContent = 'Copy handles'; }, 2000);
      }).catch(function() {
        prompt('Copy these handles:', handles.join('\n'));
      });
    });

    // Copy people handles (selected only)
    document.getElementById('copyPeopleBtn').addEventListener('click', function() {
      var btn = this;
      var handles = [];
      document.querySelectorAll('.done-checkbox-people:checked').forEach(function(cb) {
        handles.push('@' + cb.dataset.handle);
      });
      
      if (handles.length === 0) {
        btn.textContent = 'Select some first';
        setTimeout(function() { btn.textContent = 'Copy handles'; }, 2000);
        return;
      }
      
      copyToClipboard(handles.join('\n')).then(function() {
        btn.textContent = '‚úì Copied ' + handles.length;
        setTimeout(function() { btn.textContent = 'Copy handles'; }, 2000);
      }).catch(function() {
        prompt('Copy these handles:', handles.join('\n'));
      });
    });

    // Select all dead weight
    document.getElementById('selectAllDead').addEventListener('change', function() {
      var checked = this.checked;
      document.querySelectorAll('.done-checkbox-dead').forEach(function(cb) {
        cb.checked = checked;
      });
    });

    // Select all people (checkbox)
    document.getElementById('selectAllPeople').addEventListener('change', function() {
      var checked = this.checked;
      document.querySelectorAll('.done-checkbox-people').forEach(function(cb) {
        cb.checked = checked;
      });
    });
    
    // Select all people (button)
    document.getElementById('selectAllPeopleBtn').addEventListener('click', function() {
      document.getElementById('selectAllPeople').checked = true;
      document.querySelectorAll('.done-checkbox-people').forEach(function(cb) {
        cb.checked = true;
      });
    });

    // Copy tip address
    document.getElementById('copyTipBtn').addEventListener('click', function() {
      var btn = this;
      var address = document.getElementById('tipAddress').textContent;
      copyToClipboard(address).then(function() {
        btn.textContent = '‚úì Copied';
        setTimeout(function() { btn.textContent = 'Copy'; }, 2000);
      });
    });

    // Simple results display
    function showResultsOrListSetup() {
      var resultsSection = document.getElementById('resultsSection');
      if (resultsSection) {
        resultsSection.style.display = 'block';
      }
    }

    // Logo click - go home
    document.getElementById('logoBtn').addEventListener('click', function() {
      location.reload();
    });

    // Change archive - go back to upload
    document.getElementById('changeArchiveBtn').addEventListener('click', function() {
      document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
      document.getElementById('page1').classList.add('active');
      // Reset processing UI
      document.getElementById('processingInfo').classList.remove('active');
      document.getElementById('uploadProgress').style.width = '0%';
    });

    // ====== RESOLVE HANDLES LOGIC ======
    var resolveState = {
      isResolving: false,
      isPaused: false,
      resolved: 0,
      total: 0,
      cache: {} // userId -> handle mapping
    };

    // Load cached mappings from localStorage
    function loadHandleCache() {
      try {
        var cached = localStorage.getItem('fixfeed_handle_cache');
        if (cached) {
          resolveState.cache = JSON.parse(cached);
          console.log('Loaded', Object.keys(resolveState.cache).length, 'cached handle mappings');
        }
      } catch (e) {
        console.error('Error loading cache:', e);
      }
    }

    // Save cache to localStorage
    function saveHandleCache() {
      try {
        localStorage.setItem('fixfeed_handle_cache', JSON.stringify(resolveState.cache));
      } catch (e) {
        console.error('Error saving cache:', e);
      }
    }

    // Check if we need to show resolve prompt - DISABLED since Your People uses handles from engagement data
    function checkShowResolvePrompt() {
      // Don't show resolve prompt - we have handles from likes/tweets
      var prompt = document.getElementById('resolvePrompt');
      prompt.style.display = 'none';
    }

    // Apply cached handles to accounts
    function applyCachedHandles() {
      var updated = 0;
      allAccounts.forEach(function(a) {
        if (a.userId && resolveState.cache[a.userId]) {
          var handle = resolveState.cache[a.userId];
          a.handle = handle;
          a.name = handle;
          a.profileUrl = 'https://x.com/' + handle;
          updated++;
        }
      });
      console.log('Applied', updated, 'cached handles');
      if (updated > 0) {
        renderDeadList();
        recalculateEngagement();
      }
    }

    // Recalculate engagement now that we have handles
    function recalculateEngagement() {
      var likeCounts = window.likeCounts || {};
      var replyCounts = window.replyCounts || {};
      var lastLikeDates = window.lastLikeDates || {};
      var lastReplyDates = window.lastReplyDates || {};
      
      allAccounts.forEach(function(a) {
        if (a.handle && !a.handle.startsWith('user_id=')) {
          var handle = a.handle.toLowerCase();
          a.likes = likeCounts[handle] || 0;
          a.replies = replyCounts[handle] || 0;
          a.engagements = a.likes + a.replies;
          var lastLike = lastLikeDates[handle];
          var lastReply = lastReplyDates[handle];
          if (lastLike && lastReply) a.lastEngaged = lastLike > lastReply ? lastLike : lastReply;
          else a.lastEngaged = lastLike || lastReply || null;
        }
      });
      
      // Update counts
      var deadAccounts = allAccounts.filter(function(a) { return a.engagements === 0; });
      var engagedAccounts = allAccounts.filter(function(a) { return a.engagements > 0; });
      document.getElementById('deadCount').textContent = deadAccounts.length;
      document.getElementById('peopleCount').textContent = engagedAccounts.length;
      
      renderDeadList();
      renderPeopleList();
    }

    // Start resolving handles via extension
    document.getElementById('startResolveBtn').addEventListener('click', function() {
      startResolving();
    });
    
    // Skip resolve and view raw data
    document.getElementById('skipResolveBtn').addEventListener('click', function(e) {
      e.preventDefault();
      document.getElementById('resolvePrompt').style.display = 'none';
    });

    // Pause/resume button
    document.getElementById('pauseResolveBtnGlobal').addEventListener('click', function() {
      if (resolveState.isPaused) {
        resolveState.isPaused = false;
        this.textContent = 'Pause';
        continueResolving();
      } else {
        resolveState.isPaused = true;
        this.textContent = 'Resume';
      }
    });

    function startResolving() {
      // Get unresolved accounts
      var toResolve = allAccounts.filter(function(a) {
        return a.userId && !resolveState.cache[a.userId];
      });
      
      if (toResolve.length === 0) {
        alert('All handles already resolved!');
        document.getElementById('resolvePrompt').style.display = 'none';
        return;
      }
      
      resolveState.isResolving = true;
      resolveState.isPaused = false;
      resolveState.resolved = 0;
      resolveState.total = toResolve.length;
      resolveState.queue = toResolve.map(function(a) { return a.userId; });
      
      // Update UI - hide prompt, show progress banner
      document.getElementById('resolvePrompt').style.display = 'none';
      document.getElementById('resolvingBannerGlobal').style.display = 'block';
      document.getElementById('resolvingTotalGlobal').textContent = resolveState.total;
      document.getElementById('resolvingCountGlobal').textContent = '0';
      document.getElementById('resolveProgressBarGlobal').style.width = '0%';
      
      continueResolving();
    }

    function continueResolving() {
      if (resolveState.isPaused || resolveState.queue.length === 0) {
        if (resolveState.queue.length === 0) {
          finishResolving();
        }
        return;
      }
      
      var userId = resolveState.queue.shift();
      
      // Post message to any listening content script from our extension
      // The extension injects a content script on fixyourfeed.xyz that relays to background
      window.postMessage({ 
        type: 'FIXFEED_RESOLVE_REQUEST', 
        userId: userId 
      }, '*');
      
      // Set timeout in case extension isn't installed
      resolveState.currentTimeout = setTimeout(function() {
        if (!resolveState.cache[userId]) {
          // Extension didn't respond - show help message
          document.getElementById('resolveStatus').style.display = 'block';
          document.getElementById('resolveStatus').innerHTML = 
            '‚ö†Ô∏è Extension not responding. Make sure:<br>' +
            '1. FixYourFeed extension is installed<br>' +
            '2. You have <a href="https://x.com" target="_blank" style="color:var(--green)">x.com</a> open in another tab<br>' +
            '3. You are logged in to X';
          document.getElementById('resolveStatus').style.color = 'var(--danger)';
          
          // Skip this one and continue
          handleResolveResponse(userId, { success: false, error: 'No extension response' });
        }
      }, 10000);
    }
    
    // Listen for responses from extension content script
    window.addEventListener('message', function(event) {
      if (event.data && event.data.type === 'FIXFEED_RESOLVE_RESPONSE') {
        // Clear timeout
        if (resolveState.currentTimeout) {
          clearTimeout(resolveState.currentTimeout);
        }
        handleResolveResponse(event.data.userId, {
          success: event.data.success,
          handle: event.data.handle,
          error: event.data.error
        });
      }
    });

    function handleResolveResponse(userId, response) {
      resolveState.resolved++;
      
      console.log('handleResolveResponse:', userId, response);
      
      if (response && response.success && response.handle) {
        resolveState.cache[userId] = response.handle;
        saveHandleCache();
        
        // Update the account in allAccounts (compare as strings)
        var userIdStr = String(userId);
        var found = false;
        allAccounts.forEach(function(a) {
          if (String(a.userId) === userIdStr) {
            a.handle = response.handle;
            a.name = response.handle;
            a.profileUrl = 'https://x.com/' + response.handle;
            found = true;
          }
        });
        console.log('Updated account for', userId, ':', found);
        
        // Re-render periodically (every 10)
        if (resolveState.resolved % 10 === 0) {
          console.log('Re-rendering at', resolveState.resolved);
          renderDeadList();
          recalculateEngagement();
        }
      }
      
      // Update progress
      document.getElementById('resolvingCountGlobal').textContent = resolveState.resolved;
      var pct = (resolveState.resolved / resolveState.total * 100).toFixed(1);
      document.getElementById('resolveProgressBarGlobal').style.width = pct + '%';
      
      // Continue with delay to avoid rate limits
      setTimeout(continueResolving, 2000);
    }

    function finishResolving() {
      resolveState.isResolving = false;
      document.getElementById('resolvingBannerGlobal').style.display = 'none';
      
      // Final render and recalculate
      renderDeadList();
      recalculateEngagement();
      
      alert('Done! Resolved ' + resolveState.resolved + ' handles.');
      checkShowResolvePrompt();
    }

    // Load cache on page load
    loadHandleCache();
  </script>
</body>
</html>
